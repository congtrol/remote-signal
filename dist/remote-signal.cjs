"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("net"),t=require("crypto"),r=require("node:stream"),n=require("fs"),i=require("stream"),s=require("zlib"),o=require("path"),a=require("os"),h=require("tls"),f=require("events"),c=require("https"),u=require("http"),l=require("url");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=d(e),g=d(t),y=d(n),_=d(i),m=d(s),b=d(o),w=d(a),E=d(h),v=d(f),S=d(c),B=d(u),A=d(l);function L(){const e=new Date;let t={},r=e.getHours();return t.hh=r<10?"0"+r:r,r=e.getMinutes(),t.mm=r<10?"0"+r:r,r=e.getSeconds(),t.ss=r<10?"0"+r:r,t}function k(e){var t={exports:{}};return e(t,t.exports),t.exports}function I(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets option of @rollup/plugin-commonjs appropriately for this require call to behave properly.')}new TextEncoder,new TextDecoder;for(var T=function(e){var t=D(e),r=t[0],n=t[1];return 3*(r+n)/4-n},C=function(e){var t,r,n=D(e),i=n[0],s=n[1],o=new N(function(e,t,r){return 3*(t+r)/4-r}(0,i,s)),a=0,h=s>0?i-4:i;for(r=0;r<h;r+=4)t=O[e.charCodeAt(r)]<<18|O[e.charCodeAt(r+1)]<<12|O[e.charCodeAt(r+2)]<<6|O[e.charCodeAt(r+3)],o[a++]=t>>16&255,o[a++]=t>>8&255,o[a++]=255&t;2===s&&(t=O[e.charCodeAt(r)]<<2|O[e.charCodeAt(r+1)]>>4,o[a++]=255&t);1===s&&(t=O[e.charCodeAt(r)]<<10|O[e.charCodeAt(r+1)]<<4|O[e.charCodeAt(r+2)]>>2,o[a++]=t>>8&255,o[a++]=255&t);return o},U=function(e){for(var t,r=e.length,n=r%3,i=[],s=16383,o=0,a=r-n;o<a;o+=s)i.push(F(e,o,o+s>a?a:o+s));1===n?(t=e[r-1],i.push(x[t>>2]+x[t<<4&63]+"==")):2===n&&(t=(e[r-2]<<8)+e[r-1],i.push(x[t>>10]+x[t>>4&63]+x[t<<2&63]+"="));return i.join("")},x=[],O=[],N="undefined"!=typeof Uint8Array?Uint8Array:Array,R="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=0,P=R.length;M<P;++M)x[M]=R[M],O[R.charCodeAt(M)]=M;function D(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function F(e,t,r){for(var n,i,s=[],o=t;o<r;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(x[(i=n)>>18&63]+x[i>>12&63]+x[i>>6&63]+x[63&i]);return s.join("")}O["-".charCodeAt(0)]=62,O["_".charCodeAt(0)]=63;var $={byteLength:T,toByteArray:C,fromByteArray:U},H=function(e,t,r,n,i){var s,o,a=8*i-n-1,h=(1<<a)-1,f=h>>1,c=-7,u=r?i-1:0,l=r?-1:1,d=e[t+u];for(u+=l,s=d&(1<<-c)-1,d>>=-c,c+=a;c>0;s=256*s+e[t+u],u+=l,c-=8);for(o=s&(1<<-c)-1,s>>=-c,c+=n;c>0;o=256*o+e[t+u],u+=l,c-=8);if(0===s)s=1-f;else{if(s===h)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,n),s-=f}return(d?-1:1)*o*Math.pow(2,s-n)},W=function(e,t,r,n,i,s){var o,a,h,f=8*s-i-1,c=(1<<f)-1,u=c>>1,l=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:s-1,p=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=c):(o=Math.floor(Math.log(t)/Math.LN2),t*(h=Math.pow(2,-o))<1&&(o--,h*=2),(t+=o+u>=1?l/h:l*Math.pow(2,1-u))*h>=2&&(o++,h/=2),o+u>=c?(a=0,o=c):o+u>=1?(a=(t*h-1)*Math.pow(2,i),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,i),o=0));i>=8;e[r+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,f+=i;f>0;e[r+d]=255&o,d+=p,o/=256,f-=8);e[r+d-p]|=128*g},j=k((function(e,t){const r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=s,t.SlowBuffer=function(e){+e!=e&&(e=0);return s.alloc(+e)},t.INSPECT_MAX_BYTES=50;const n=2147483647;function i(e){if(e>n)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,s.prototype),t}function s(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return h(e)}return o(e,t,r)}function o(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!s.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const r=0|l(e,t);let n=i(r);const o=n.write(e,t);o!==r&&(n=n.slice(0,o));return n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(K(e,Uint8Array)){const t=new Uint8Array(e);return c(t.buffer,t.byteOffset,t.byteLength)}return f(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(K(e,ArrayBuffer)||e&&K(e.buffer,ArrayBuffer))return c(e,t,r);if("undefined"!=typeof SharedArrayBuffer&&(K(e,SharedArrayBuffer)||e&&K(e.buffer,SharedArrayBuffer)))return c(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return s.from(n,t,r);const o=function(e){if(s.isBuffer(e)){const t=0|u(e.length),r=i(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||J(e.length)?i(0):f(e);if("Buffer"===e.type&&Array.isArray(e.data))return f(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return s.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function a(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e){return a(e),i(e<0?0:0|u(e))}function f(e){const t=e.length<0?0:0|u(e.length),r=i(t);for(let n=0;n<t;n+=1)r[n]=255&e[n];return r}function c(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),Object.setPrototypeOf(n,s.prototype),n}function u(e){if(e>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return 0|e}function l(e,t){if(s.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||K(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return q(e).length;default:if(i)return n?-1:V(e).length;t=(""+t).toLowerCase(),i=!0}}function d(e,t,r){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return k(this,t,r);case"utf8":case"utf-8":return S(this,t,r);case"ascii":return A(this,t,r);case"latin1":case"binary":return L(this,t,r);case"base64":return v(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function g(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),J(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=s.from(t,n)),s.isBuffer(t))return 0===t.length?-1:y(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):y(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function y(e,t,r,n,i){let s,o=1,a=e.length,h=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,a/=2,h/=2,r/=2}function f(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){let n=-1;for(s=r;s<a;s++)if(f(e,s)===f(t,-1===n?0:s-n)){if(-1===n&&(n=s),s-n+1===h)return n*o}else-1!==n&&(s-=s-n),n=-1}else for(r+h>a&&(r=a-h),s=r;s>=0;s--){let r=!0;for(let n=0;n<h;n++)if(f(e,s+n)!==f(t,n)){r=!1;break}if(r)return s}return-1}function _(e,t,r,n){r=Number(r)||0;const i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;const s=t.length;let o;for(n>s/2&&(n=s/2),o=0;o<n;++o){const n=parseInt(t.substr(2*o,2),16);if(J(n))return o;e[r+o]=n}return o}function m(e,t,r,n){return Y(V(t,e.length-r),e,r,n)}function b(e,t,r,n){return Y(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function w(e,t,r,n){return Y(q(t),e,r,n)}function E(e,t,r,n){return Y(function(e,t){let r,n,i;const s=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)r=e.charCodeAt(o),n=r>>8,i=r%256,s.push(i),s.push(n);return s}(t,e.length-r),e,r,n)}function v(e,t,r){return 0===t&&r===e.length?$.fromByteArray(e):$.fromByteArray(e.slice(t,r))}function S(e,t,r){r=Math.min(e.length,r);const n=[];let i=t;for(;i<r;){const t=e[i];let s=null,o=t>239?4:t>223?3:t>191?2:1;if(i+o<=r){let r,n,a,h;switch(o){case 1:t<128&&(s=t);break;case 2:r=e[i+1],128==(192&r)&&(h=(31&t)<<6|63&r,h>127&&(s=h));break;case 3:r=e[i+1],n=e[i+2],128==(192&r)&&128==(192&n)&&(h=(15&t)<<12|(63&r)<<6|63&n,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:r=e[i+1],n=e[i+2],a=e[i+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(h=(15&t)<<18|(63&r)<<12|(63&n)<<6|63&a,h>65535&&h<1114112&&(s=h))}}null===s?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),i+=o}return function(e){const t=e.length;if(t<=B)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=B));return r}(n)}t.kMaxLength=n,s.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),s.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),s.poolSize=8192,s.from=function(e,t,r){return o(e,t,r)},Object.setPrototypeOf(s.prototype,Uint8Array.prototype),Object.setPrototypeOf(s,Uint8Array),s.alloc=function(e,t,r){return function(e,t,r){return a(e),e<=0?i(e):void 0!==t?"string"==typeof r?i(e).fill(t,r):i(e).fill(t):i(e)}(e,t,r)},s.allocUnsafe=function(e){return h(e)},s.allocUnsafeSlow=function(e){return h(e)},s.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==s.prototype},s.compare=function(e,t){if(K(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),K(t,Uint8Array)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);let r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;const n=s.allocUnsafe(t);let i=0;for(r=0;r<e.length;++r){let t=e[r];if(K(t,Uint8Array))i+t.length>n.length?(s.isBuffer(t)||(t=s.from(t)),t.copy(n,i)):Uint8Array.prototype.set.call(n,t,i);else{if(!s.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,i)}i+=t.length}return n},s.byteLength=l,s.prototype._isBuffer=!0,s.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)p(this,t,t+1);return this},s.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},s.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},s.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?S(this,0,e):d.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){let e="";const r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},r&&(s.prototype[r]=s.prototype.inspect),s.prototype.compare=function(e,t,r,n,i){if(K(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;let o=(i>>>=0)-(n>>>=0),a=(r>>>=0)-(t>>>=0);const h=Math.min(o,a),f=this.slice(n,i),c=e.slice(t,r);for(let e=0;e<h;++e)if(f[e]!==c[e]){o=f[e],a=c[e];break}return o<a?-1:a<o?1:0},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.indexOf=function(e,t,r){return g(this,e,t,r,!0)},s.prototype.lastIndexOf=function(e,t,r){return g(this,e,t,r,!1)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return m(this,e,t,r);case"ascii":case"latin1":case"binary":return b(this,e,t,r);case"base64":return w(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const B=4096;function A(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function L(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function k(e,t,r){const n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=t;n<r;++n)i+=Q[e[n]];return i}function I(e,t,r){const n=e.slice(t,r);let i="";for(let e=0;e<n.length-1;e+=2)i+=String.fromCharCode(n[e]+256*n[e+1]);return i}function T(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function C(e,t,r,n,i,o){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function U(e,t,r,n,i){F(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,r}function x(e,t,r,n,i){F(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r+7]=s,s>>=8,e[r+6]=s,s>>=8,e[r+5]=s,s>>=8,e[r+4]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=o,o>>=8,e[r+2]=o,o>>=8,e[r+1]=o,o>>=8,e[r]=o,r+8}function O(e,t,r,n,i,s){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function N(e,t,r,n,i){return t=+t,r>>>=0,i||O(e,0,r,4),W(e,t,r,n,23,4),r+4}function R(e,t,r,n,i){return t=+t,r>>>=0,i||O(e,0,r,8),W(e,t,r,n,52,8),r+8}s.prototype.slice=function(e,t){const r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,s.prototype),n},s.prototype.readUintLE=s.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return n},s.prototype.readUintBE=s.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUint8=s.prototype.readUInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),this[e]},s.prototype.readUint16LE=s.prototype.readUInt16LE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUint16BE=s.prototype.readUInt16BE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUint32LE=s.prototype.readUInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUint32BE=s.prototype.readUInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readBigUInt64LE=X((function(e){j(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||G(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))})),s.prototype.readBigUInt64BE=X((function(e){j(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||G(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)})),s.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=t,i=1,s=this[e+--n];for(;n>0&&(i*=256);)s+=this[e+--n]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s},s.prototype.readInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){e>>>=0,t||T(e,2,this.length);const r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){e>>>=0,t||T(e,2,this.length);const r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readBigInt64LE=X((function(e){j(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||G(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),s.prototype.readBigInt64BE=X((function(e){j(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||G(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+r)})),s.prototype.readFloatLE=function(e,t){return e>>>=0,t||T(e,4,this.length),H(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return e>>>=0,t||T(e,4,this.length),H(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return e>>>=0,t||T(e,8,this.length),H(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return e>>>=0,t||T(e,8,this.length),H(this,e,!1,52,8)},s.prototype.writeUintLE=s.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){C(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=1,s=0;for(this[t]=255&e;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r},s.prototype.writeUintBE=s.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){C(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=r-1,s=1;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r},s.prototype.writeUint8=s.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,1,255,0),this[t]=255&e,t+1},s.prototype.writeUint16LE=s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeUint16BE=s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeUint32LE=s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},s.prototype.writeUint32BE=s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigUInt64LE=X((function(e,t=0){return U(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeBigUInt64BE=X((function(e,t=0){return x(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);C(this,e,t,r,n-1,-n)}let i=0,s=1,o=0;for(this[t]=255&e;++i<r&&(s*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);C(this,e,t,r,n-1,-n)}let i=r-1,s=1,o=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigInt64LE=X((function(e,t=0){return U(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeBigInt64BE=X((function(e,t=0){return x(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeFloatLE=function(e,t,r){return N(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return N(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return R(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return R(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(!s.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);const i=n-r;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;let i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{const o=s.isBuffer(e)?e:s.from(e,n),a=o.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=o[i%a]}return this};const M={};function P(e,t,r){M[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function D(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function F(e,t,r,n,i,s){if(e>r||e<t){const n="bigint"==typeof t?"n":"";let i;throw i=s>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(s+1)}${n}`:`>= -(2${n} ** ${8*(s+1)-1}${n}) and < 2 ** ${8*(s+1)-1}${n}`:`>= ${t}${n} and <= ${r}${n}`,new M.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,r){j(t,"offset"),void 0!==e[t]&&void 0!==e[t+r]||G(t,e.length-(r+1))}(n,i,s)}function j(e,t){if("number"!=typeof e)throw new M.ERR_INVALID_ARG_TYPE(t,"number",e)}function G(e,t,r){if(Math.floor(e)!==e)throw j(e,r),new M.ERR_OUT_OF_RANGE(r||"offset","an integer",e);if(t<0)throw new M.ERR_BUFFER_OUT_OF_BOUNDS;throw new M.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}P("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),P("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),P("ERR_OUT_OF_RANGE",(function(e,t,r){let n=`The value of "${e}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=D(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=D(i)),i+="n"),n+=` It must be ${t}. Received ${i}`,n}),RangeError);const z=/[^+/0-9A-Za-z-_]/g;function V(e,t){let r;t=t||1/0;const n=e.length;let i=null;const s=[];for(let o=0;o<n;++o){if(r=e.charCodeAt(o),r>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&s.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&s.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&s.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;s.push(r)}else if(r<2048){if((t-=2)<0)break;s.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;s.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return s}function q(e){return $.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(z,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,r,n){let i;for(i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function K(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function J(e){return e!=e}const Q=function(){const e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)t[n+i]=e[r]+e[i]}return t}();function X(e){return"undefined"==typeof BigInt?Z:e}function Z(){throw new Error("BigInt not supported")}}));
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */const G=new TextEncoder,z=new TextDecoder,V=q;function q(e,t=0){let r;if(void 0===e||"string"!=typeof e||"number"!=typeof t)throw TypeError("invlaid init variablie type name. ");return(e=e.toUpperCase()).includes("8")?(r=j.Buffer.alloc(1),e.includes("I")?r.writeInt8(t):r.writeUint8(t)):e.includes("16")?(r=j.Buffer.alloc(2),e.includes("I")?e.includes("L")?r.writeInt16LE(t):r.writeInt16BE(t):e.includes("L")?r.writeUint16LE(t):r.writeUint16BE(t)):e.includes("32")?(r=j.Buffer.alloc(4),e.includes("I")?e.includes("L")?r.writeInt32LE(t):r.writeInt32BE(t):e.includes("L")?r.writeUint32LE(t):r.writeUint32BE(t)):e.includes("F")?(r=j.Buffer.alloc(4),e.includes("L")?r.writeFloatLE(t):r.writeFloatBE(t)):e.includes("N")?r=j.Buffer.from(String(t)):console.log(`invalid type: ${e} or initvalue: ${t}`),r}const Y=function(e,t,r){let n,i="B";if("number"==typeof t)"number"==typeof r?(n=j.Buffer.alloc(t),0!==r&&n.fill(r),i="B"):(n=j.Buffer.from(String(t)),i="N");else if("string"==typeof t&&"number"==typeof r)i=t.toUpperCase(),n=q(t,r);else if("string"==typeof t&&void 0===r)n=j.Buffer.from(t),i="S";else if(t instanceof Uint8Array&&void 0===r)n=t instanceof j.Buffer?t:j.Buffer.from(t);else if(t instanceof ArrayBuffer&&void 0===r)n=j.Buffer.from(t);else if(ArrayBuffer.isView(t))n=j.Buffer.from(t.buffer,t.byteOffset,t.byteLength);else if("object"==typeof t&&void 0===r)n=j.Buffer.from(JSON.stringify(t)),i="O";else{if("boolean"!=typeof t||void 0!==r)throw TypeError("invalid meta buffer type");{const e=t?1:0;n=j.Buffer.from([e]),i="!"}}"string"==typeof e&&e.includes("#")&&(e="");return[e,i,n]};const K=function(...e){let t=0;return e.map((e=>{const r=t++;return"number"==typeof e?Y(r,"N",e):Y(r,e)}))};function J(e){if((e=e.toUpperCase()).includes("8"))return e.includes("I")?"int8":"uint8";if(e.includes("16"))return e.includes("I")?e.includes("L")?"int16_le":"int16_be":e.includes("L")?"uint16_le":"uint16_be";if(e.includes("32"))return e.includes("I")?e.includes("L")?"int32_le":"int32_be":e.includes("L")?"uint32_le":"uint32_be";if(e.includes("F"))return e.includes("L")?"float_le":"float_be";if("B"===e)return"buffer";if("S"===e)return"string";if("N"===e)return"number";if("O"===e)return"object";if("!"===e)return"boolean";throw TypeError("invalid data type")}function Q(e,t,r,n){const i=J(e);if("int8"==i)return t.readInt8(r);if("uint8"===i)return t.readUint8(r);if("int16_le"===i)return t.readInt16LE(r);if("int16_be"===i)return t.readInt16BE(r);if("uint16_le"===i)return t.readUint16LE(r);if("uint16_be"===i)return t.readUint16BE(r);if("int32_le"===i)return t.readInt32LE(r);if("int32_be"===i)return t.readInt32BE(r);if("uint32_le"===i)return t.readUint32LE(r);if("uint32_be"===i)return t.readUint32BE(r);if("float_le"===i)return t.readFloatLE(r);if("float_be"===i)return t.readFloatBE(r);if("buffer"===i)return t.subarray(r,r+n);if("string"===i){const e=t.subarray(r,r+n);return z.decode(e)}if("number"===i){const e=t.subarray(r,r+n);return Number(z.decode(e))}if("object"!==i){if("boolean"===i){return 1===t.readInt8(r)}throw TypeError("invalid data")}{const e=t.subarray(r,r+n);try{return JSON.parse(z.decode(e))}catch(e){console.log("err. obj parse")}}}function X(...e){const t=function(e){let t=[];return e.filter((e=>{if(!Array.isArray(e[0]))return e;t=t.concat(e)})).concat(t)}(e);let r=0;const n=[];let i,s,o=0;if(t.forEach((e=>{const[t,i,s]=e;r+=s.byteLength,("number"==typeof t||t.length>0)&&n.push([t,i,o,s.byteLength]),o=r})),n.length>0){let e=JSON.stringify(n);i=G.encode(e),s=i.byteLength,r=r+s+2}const a=j.Buffer.alloc(r);if(o=0,t.forEach((e=>{const t=e[2];a.set(t,o),o+=t.byteLength})),n.length>0){a.set(i,o);const e=V("16",s);return a.set(e,o+s),a}return a}function Z(e,t){const r=t||ne(e);if(!r)return;const n=j.Buffer.from(e),i={};let s=0;if(r.forEach((e=>{const[t,r,o,a]=e;i[t]=Q(r,n,o,a),a&&(s+=a)})),t&&n.byteLength!==s){let e=n.byteLength-s;i.$OTHERS=Q("b",n,s,e)}let o=0,a=[];for(;i[o];)a.push(i[o++]);return a.length>0&&(i.args=a,i.$=i.args),i}function ee(e,t=!1){if(void 0===e)throw TypeError("Invalid data type: Undefined");if("string"==typeof e)return G.encode(e);if("number"==typeof e)return Uint8Array.from([e]);if(e instanceof ArrayBuffer){if(t)return new Uint8Array(e);{const t=new Uint8Array(e),r=new Uint8Array(e.byteLength);return r.set(t),r}}if(ArrayBuffer.isView(e)){if(t)return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);{const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=new Uint8Array(e.byteLength);return r.set(t),r}}return G.encode(JSON.stringify(e))}const te=function(e,t=!1){const r=ee(e,t);return t?j.Buffer.from(r.buffer,r.byteOffset,r.byteLength):j.Buffer.from(r)};const re=function(...e){try{let t=0,r=0;const n=e.map((e=>ee(e)));n.forEach((e=>{t+=e.byteLength}));const i=new Uint8Array(t);return n.forEach((e=>{i.set(e,r),r+=e.byteLength})),i}catch(e){console.log(e)}};function ne(e,t=!1){e instanceof ArrayBuffer&&(e=j.Buffer.from(e));const r=function(e){if(e instanceof ArrayBuffer&&(e=j.Buffer.from(e)),e instanceof Uint8Array)return e.byteLength<=2?0:new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(e.byteLength-2);return 0}(e);if(0===r)return;let n=function(e,t){try{const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=r.byteLength-t-2,i=r.subarray(n,r.byteLength-2),s=z.decode(i),o=JSON.parse(s);if(!Array.isArray(o)||!Array.isArray(o[0]))return;let a=o[0];if(!a)return;if(a.length<3)return;const[h,f,c]=a;if("string"!=typeof f||"number"!=typeof c)return;return o}catch(e){}}(e,r);return n?t?(n.forEach((e=>{null==e[3]&&(e[1].includes("8")?e[3]=1:e[1].includes("16")?e[3]=2:e[1].includes("32")||e[1].includes("F")?e[3]=4:e[1].includes("!")&&(e[3]=1)),e[4]=J(e[1])})),n):n:void 0}const ie=1,se=2,oe=3,ae=4;function he(e){if(e.byteLength<256)return X(Y("#type","8",ie),Y("#payloadLen1","8",e.byteLength),Y("#payload",e));if(e.byteLength<65536)return X(Y("#type","8",se),Y("#payloadLen2","16L",e.byteLength),Y("#payload",e));if(e.byteLength<2**24){let t=Buffer.alloc(4);t.writeUint32LE(e.byteLength);let r=t.subarray(0,3);return X(Y("#type","8",oe),Y("#payloadLen3",r),Y("#payload",e))}return X(Y("#type","8",ae),Y("#payloadLen4","32L",e.byteLength),Y("#payload",e))}class fe extends r.Transform{constructor(e){super(e),this.buffer=Buffer.alloc(0),this.frames=[],this.rxi=0,this.rxi_zero=0}_transform(e,t,r){this.addData(e),this.frames.length>0&&(this.frames.forEach((e=>{this.push(e)})),this.frames=[]),r()}addData(e){let t=e.byteLength,r=0;for(;t--;)this.rxi++,0==e[r++]&&this.rxi_zero++;this.buffer.byteLength>0?this.buffer=Buffer.concat([this.buffer,e]):this.buffer=e,this.parse()}parse(){let e,t,r=this.buffer[0];if(r==ie){if(e=2,this.buffer.byteLength<e)return;t=this.buffer.readUint8(1)}else if(r==se){if(e=3,this.buffer.byteLength<e)return;t=this.buffer.readUint16LE(1)}else if(r==oe){if(e=4,this.buffer.byteLength<e)return;t=this.buffer.readUint16LE(1)+65536*this.buffer.readUint8(3)}else if(r==ae){if(e=5,this.buffer.byteLength<e)return;t=this.buffer.readUint32LE(1)}else console.log("DROP -UNKNOWN_TYPE-  buffer: ",this.buffer),this.buffer=Buffer.alloc(0);if(t==this.buffer.byteLength-e)return this.frames.push(this.buffer.subarray(e)),void(this.buffer=Buffer.alloc(0));t<this.buffer.byteLength-e&&(this.frames.push(this.buffer.subarray(e,e+t)),this.buffer=this.buffer.subarray(e+t),this.parse())}}let ce={showMessage:"none",showMetric:0,useLogger:!1,adminChannel:null,pingTimeout:5e4,monitorPeriod:3e3};const ue=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function le(e,t,r,n,i){let s,o,a,h,f,c,u,l,d,p,g,y,_;for(;i>=64;){for(s=t[0],o=t[1],a=t[2],h=t[3],f=t[4],c=t[5],u=t[6],l=t[7],p=0;p<16;p++)g=n+4*p,e[p]=(255&r[g])<<24|(255&r[g+1])<<16|(255&r[g+2])<<8|255&r[g+3];for(p=16;p<64;p++)d=e[p-2],y=(d>>>17|d<<15)^(d>>>19|d<<13)^d>>>10,d=e[p-15],_=(d>>>7|d<<25)^(d>>>18|d<<14)^d>>>3,e[p]=(y+e[p-7]|0)+(_+e[p-16]|0);for(p=0;p<64;p++)y=(((f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&c^~f&u)|0)+(l+(ue[p]+e[p]|0)|0)|0,_=((s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10))+(s&o^s&a^o&a)|0,l=u,u=c,c=f,f=h+y|0,h=a,a=o,o=s,s=y+_|0;t[0]+=s,t[1]+=o,t[2]+=a,t[3]+=h,t[4]+=f,t[5]+=c,t[6]+=u,t[7]+=l,n+=64,i-=64}return n}const de=function(){function e(){this.digestLength=32,this.blockSize=64,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}return e.prototype.reset=function(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this},e.prototype.clean=function(){for(var e=0;e<this.buffer.length;e++)this.buffer[e]=0;for(e=0;e<this.temp.length;e++)this.temp[e]=0;this.reset()},e.prototype.update=function(e,t){if(void 0===t&&(t=e.length),this.finished)throw new Error("SHA256: can't update because hash was finished.");let r=0;if(this.bytesHashed+=t,this.bufferLength>0){for(;this.bufferLength<64&&t>0;)this.buffer[this.bufferLength++]=e[r++],t--;64===this.bufferLength&&(le(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(t>=64&&(r=le(this.temp,this.state,e,r,t),t%=64);t>0;)this.buffer[this.bufferLength++]=e[r++],t--;return this},e.prototype.finish=function(e){if(!this.finished){const e=this.bytesHashed,r=this.bufferLength,n=e/536870912|0,i=e<<3,s=e%64<56?64:128;this.buffer[r]=128;for(var t=r+1;t<s-8;t++)this.buffer[t]=0;this.buffer[s-8]=n>>>24&255,this.buffer[s-7]=n>>>16&255,this.buffer[s-6]=n>>>8&255,this.buffer[s-5]=n>>>0&255,this.buffer[s-4]=i>>>24&255,this.buffer[s-3]=i>>>16&255,this.buffer[s-2]=i>>>8&255,this.buffer[s-1]=i>>>0&255,le(this.temp,this.state,this.buffer,0,s),this.finished=!0}for(t=0;t<8;t++)e[4*t+0]=this.state[t]>>>24&255,e[4*t+1]=this.state[t]>>>16&255,e[4*t+2]=this.state[t]>>>8&255,e[4*t+3]=this.state[t]>>>0&255;return this},e.prototype.digest=function(){const e=new Uint8Array(this.digestLength);return this.finish(e),e},e.prototype._saveState=function(e){for(let t=0;t<this.state.length;t++)e[t]=this.state[t]},e.prototype._restoreState=function(e,t){for(let t=0;t<this.state.length;t++)this.state[t]=e[t];this.bytesHashed=t,this.finished=!1,this.bufferLength=0},e}(),pe=function(){function e(e){this.inner=new de,this.outer=new de,this.blockSize=this.inner.blockSize,this.digestLength=this.inner.digestLength;const t=new Uint8Array(this.blockSize);if(e.length>this.blockSize)(new de).update(e).finish(t).clean();else for(var r=0;r<e.length;r++)t[r]=e[r];for(r=0;r<t.length;r++)t[r]^=54;for(this.inner.update(t),r=0;r<t.length;r++)t[r]^=106;for(this.outer.update(t),this.istate=new Uint32Array(8),this.ostate=new Uint32Array(8),this.inner._saveState(this.istate),this.outer._saveState(this.ostate),r=0;r<t.length;r++)t[r]=0}return e.prototype.reset=function(){return this.inner._restoreState(this.istate,this.inner.blockSize),this.outer._restoreState(this.ostate,this.outer.blockSize),this},e.prototype.clean=function(){for(let e=0;e<this.istate.length;e++)this.ostate[e]=this.istate[e]=0;this.inner.clean(),this.outer.clean()},e.prototype.update=function(e){return this.inner.update(e),this},e.prototype.finish=function(e){return this.outer.finished?this.outer.finish(e):(this.inner.finish(e),this.outer.update(e,this.digestLength).finish(e)),this},e.prototype.digest=function(){const e=new Uint8Array(this.digestLength);return this.finish(e),e},e}();function ge(e){const t=(new de).update(e),r=t.digest();return t.clean(),r}for(var ye=[],_e=[],me="undefined"!=typeof Uint8Array?Uint8Array:Array,be="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",we=0,Ee=be.length;we<Ee;++we)ye[we]=be[we],_e[be.charCodeAt(we)]=we;function ve(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function Se(e,t,r){for(var n,i,s=[],o=t;o<r;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(ye[(i=n)>>18&63]+ye[i>>12&63]+ye[i>>6&63]+ye[63&i]);return s.join("")}_e["-".charCodeAt(0)]=62,_e["_".charCodeAt(0)]=63;var Be,Ae,Le=function(e){var t,r,n=ve(e),i=n[0],s=n[1],o=new me(function(e,t,r){return 3*(t+r)/4-r}(0,i,s)),a=0,h=s>0?i-4:i;for(r=0;r<h;r+=4)t=_e[e.charCodeAt(r)]<<18|_e[e.charCodeAt(r+1)]<<12|_e[e.charCodeAt(r+2)]<<6|_e[e.charCodeAt(r+3)],o[a++]=t>>16&255,o[a++]=t>>8&255,o[a++]=255&t;return 2===s&&(t=_e[e.charCodeAt(r)]<<2|_e[e.charCodeAt(r+1)]>>4,o[a++]=255&t),1===s&&(t=_e[e.charCodeAt(r)]<<10|_e[e.charCodeAt(r+1)]<<4|_e[e.charCodeAt(r+2)]>>2,o[a++]=t>>8&255,o[a++]=255&t),o},ke=function(e){for(var t,r=e.length,n=r%3,i=[],s=16383,o=0,a=r-n;o<a;o+=s)i.push(Se(e,o,o+s>a?a:o+s));return 1===n?(t=e[r-1],i.push(ye[t>>2]+ye[t<<4&63]+"==")):2===n&&(t=(e[r-2]<<8)+e[r-1],i.push(ye[t>>10]+ye[t>>4&63]+ye[t<<2&63]+"=")),i.join("")},Ie=function(e,t,r,n,i){var s,o,a=8*i-n-1,h=(1<<a)-1,f=h>>1,c=-7,u=r?i-1:0,l=r?-1:1,d=e[t+u];for(u+=l,s=d&(1<<-c)-1,d>>=-c,c+=a;c>0;s=256*s+e[t+u],u+=l,c-=8);for(o=s&(1<<-c)-1,s>>=-c,c+=n;c>0;o=256*o+e[t+u],u+=l,c-=8);if(0===s)s=1-f;else{if(s===h)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,n),s-=f}return(d?-1:1)*o*Math.pow(2,s-n)},Te=function(e,t,r,n,i,s){var o,a,h,f=8*s-i-1,c=(1<<f)-1,u=c>>1,l=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:s-1,p=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=c):(o=Math.floor(Math.log(t)/Math.LN2),t*(h=Math.pow(2,-o))<1&&(o--,h*=2),(t+=o+u>=1?l/h:l*Math.pow(2,1-u))*h>=2&&(o++,h/=2),o+u>=c?(a=0,o=c):o+u>=1?(a=(t*h-1)*Math.pow(2,i),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,i),o=0));i>=8;e[r+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,f+=i;f>0;e[r+d]=255&o,d+=p,o/=256,f-=8);e[r+d-p]|=128*g},Ce=(Be=function(e,t){const r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=s,t.SlowBuffer=function(e){return+e!=e&&(e=0),s.alloc(+e)},t.INSPECT_MAX_BYTES=50;const n=2147483647;function i(e){if(e>n)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,s.prototype),t}function s(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return h(e)}return o(e,t,r)}function o(e,t,r){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!s.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const r=0|l(e,t);let n=i(r);const o=n.write(e,t);return o!==r&&(n=n.slice(0,o)),n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(V(e,Uint8Array)){const t=new Uint8Array(e);return c(t.buffer,t.byteOffset,t.byteLength)}return f(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(V(e,ArrayBuffer)||e&&V(e.buffer,ArrayBuffer))return c(e,t,r);if("undefined"!=typeof SharedArrayBuffer&&(V(e,SharedArrayBuffer)||e&&V(e.buffer,SharedArrayBuffer)))return c(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return s.from(n,t,r);const o=function(e){if(s.isBuffer(e)){const t=0|u(e.length),r=i(t);return 0===r.length||e.copy(r,0,0,t),r}return void 0!==e.length?"number"!=typeof e.length||q(e.length)?i(0):f(e):"Buffer"===e.type&&Array.isArray(e.data)?f(e.data):void 0}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return s.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function a(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e){return a(e),i(e<0?0:0|u(e))}function f(e){const t=e.length<0?0:0|u(e.length),r=i(t);for(let n=0;n<t;n+=1)r[n]=255&e[n];return r}function c(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),Object.setPrototypeOf(n,s.prototype),n}function u(e){if(e>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return 0|e}function l(e,t){if(s.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||V(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return j(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return G(e).length;default:if(i)return n?-1:j(e).length;t=(""+t).toLowerCase(),i=!0}}function d(e,t,r){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return k(this,t,r);case"utf8":case"utf-8":return S(this,t,r);case"ascii":return A(this,t,r);case"latin1":case"binary":return L(this,t,r);case"base64":return v(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function g(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),q(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=s.from(t,n)),s.isBuffer(t))return 0===t.length?-1:y(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):y(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function y(e,t,r,n,i){let s,o=1,a=e.length,h=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,a/=2,h/=2,r/=2}function f(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){let n=-1;for(s=r;s<a;s++)if(f(e,s)===f(t,-1===n?0:s-n)){if(-1===n&&(n=s),s-n+1===h)return n*o}else-1!==n&&(s-=s-n),n=-1}else for(r+h>a&&(r=a-h),s=r;s>=0;s--){let r=!0;for(let n=0;n<h;n++)if(f(e,s+n)!==f(t,n)){r=!1;break}if(r)return s}return-1}function _(e,t,r,n){r=Number(r)||0;const i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;const s=t.length;let o;for(n>s/2&&(n=s/2),o=0;o<n;++o){const n=parseInt(t.substr(2*o,2),16);if(q(n))return o;e[r+o]=n}return o}function m(e,t,r,n){return z(j(t,e.length-r),e,r,n)}function b(e,t,r,n){return z(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function w(e,t,r,n){return z(G(t),e,r,n)}function E(e,t,r,n){return z(function(e,t){let r,n,i;const s=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)r=e.charCodeAt(o),n=r>>8,i=r%256,s.push(i),s.push(n);return s}(t,e.length-r),e,r,n)}function v(e,t,r){return 0===t&&r===e.length?ke(e):ke(e.slice(t,r))}function S(e,t,r){r=Math.min(e.length,r);const n=[];let i=t;for(;i<r;){const t=e[i];let s=null,o=t>239?4:t>223?3:t>191?2:1;if(i+o<=r){let r,n,a,h;switch(o){case 1:t<128&&(s=t);break;case 2:r=e[i+1],128==(192&r)&&(h=(31&t)<<6|63&r,h>127&&(s=h));break;case 3:r=e[i+1],n=e[i+2],128==(192&r)&&128==(192&n)&&(h=(15&t)<<12|(63&r)<<6|63&n,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:r=e[i+1],n=e[i+2],a=e[i+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(h=(15&t)<<18|(63&r)<<12|(63&n)<<6|63&a,h>65535&&h<1114112&&(s=h))}}null===s?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),i+=o}return function(e){const t=e.length;if(t<=B)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=B));return r}(n)}t.kMaxLength=n,s.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),s.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),s.poolSize=8192,s.from=function(e,t,r){return o(e,t,r)},Object.setPrototypeOf(s.prototype,Uint8Array.prototype),Object.setPrototypeOf(s,Uint8Array),s.alloc=function(e,t,r){return function(e,t,r){return a(e),e<=0?i(e):void 0!==t?"string"==typeof r?i(e).fill(t,r):i(e).fill(t):i(e)}(e,t,r)},s.allocUnsafe=function(e){return h(e)},s.allocUnsafeSlow=function(e){return h(e)},s.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==s.prototype},s.compare=function(e,t){if(V(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),V(t,Uint8Array)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);let r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;const n=s.allocUnsafe(t);let i=0;for(r=0;r<e.length;++r){let t=e[r];if(V(t,Uint8Array))i+t.length>n.length?(s.isBuffer(t)||(t=s.from(t)),t.copy(n,i)):Uint8Array.prototype.set.call(n,t,i);else{if(!s.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,i)}i+=t.length}return n},s.byteLength=l,s.prototype._isBuffer=!0,s.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)p(this,t,t+1);return this},s.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},s.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},s.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?S(this,0,e):d.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){let e="";const r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},r&&(s.prototype[r]=s.prototype.inspect),s.prototype.compare=function(e,t,r,n,i){if(V(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;let o=(i>>>=0)-(n>>>=0),a=(r>>>=0)-(t>>>=0);const h=Math.min(o,a),f=this.slice(n,i),c=e.slice(t,r);for(let e=0;e<h;++e)if(f[e]!==c[e]){o=f[e],a=c[e];break}return o<a?-1:a<o?1:0},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.indexOf=function(e,t,r){return g(this,e,t,r,!0)},s.prototype.lastIndexOf=function(e,t,r){return g(this,e,t,r,!1)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return m(this,e,t,r);case"ascii":case"latin1":case"binary":return b(this,e,t,r);case"base64":return w(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const B=4096;function A(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function L(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function k(e,t,r){const n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=t;n<r;++n)i+=Y[e[n]];return i}function I(e,t,r){const n=e.slice(t,r);let i="";for(let e=0;e<n.length-1;e+=2)i+=String.fromCharCode(n[e]+256*n[e+1]);return i}function T(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function C(e,t,r,n,i,o){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function U(e,t,r,n,i){F(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,r}function x(e,t,r,n,i){F(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r+7]=s,s>>=8,e[r+6]=s,s>>=8,e[r+5]=s,s>>=8,e[r+4]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=o,o>>=8,e[r+2]=o,o>>=8,e[r+1]=o,o>>=8,e[r]=o,r+8}function O(e,t,r,n,i,s){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function N(e,t,r,n,i){return t=+t,r>>>=0,i||O(e,0,r,4),Te(e,t,r,n,23,4),r+4}function R(e,t,r,n,i){return t=+t,r>>>=0,i||O(e,0,r,8),Te(e,t,r,n,52,8),r+8}s.prototype.slice=function(e,t){const r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,s.prototype),n},s.prototype.readUintLE=s.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return n},s.prototype.readUintBE=s.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUint8=s.prototype.readUInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),this[e]},s.prototype.readUint16LE=s.prototype.readUInt16LE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUint16BE=s.prototype.readUInt16BE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUint32LE=s.prototype.readUInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUint32BE=s.prototype.readUInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readBigUInt64LE=K((function(e){$(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))})),s.prototype.readBigUInt64BE=K((function(e){$(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)})),s.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||T(e,t,this.length);let n=t,i=1,s=this[e+--n];for(;n>0&&(i*=256);)s+=this[e+--n]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s},s.prototype.readInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){e>>>=0,t||T(e,2,this.length);const r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){e>>>=0,t||T(e,2,this.length);const r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readBigInt64LE=K((function(e){$(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),s.prototype.readBigInt64BE=K((function(e){$(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+r)})),s.prototype.readFloatLE=function(e,t){return e>>>=0,t||T(e,4,this.length),Ie(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return e>>>=0,t||T(e,4,this.length),Ie(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return e>>>=0,t||T(e,8,this.length),Ie(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return e>>>=0,t||T(e,8,this.length),Ie(this,e,!1,52,8)},s.prototype.writeUintLE=s.prototype.writeUIntLE=function(e,t,r,n){e=+e,t>>>=0,r>>>=0,n||C(this,e,t,r,Math.pow(2,8*r)-1,0);let i=1,s=0;for(this[t]=255&e;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r},s.prototype.writeUintBE=s.prototype.writeUIntBE=function(e,t,r,n){e=+e,t>>>=0,r>>>=0,n||C(this,e,t,r,Math.pow(2,8*r)-1,0);let i=r-1,s=1;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r},s.prototype.writeUint8=s.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,1,255,0),this[t]=255&e,t+1},s.prototype.writeUint16LE=s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeUint16BE=s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeUint32LE=s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},s.prototype.writeUint32BE=s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigUInt64LE=K((function(e,t=0){return U(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeBigUInt64BE=K((function(e,t=0){return x(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);C(this,e,t,r,n-1,-n)}let i=0,s=1,o=0;for(this[t]=255&e;++i<r&&(s*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);C(this,e,t,r,n-1,-n)}let i=r-1,s=1,o=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||C(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigInt64LE=K((function(e,t=0){return U(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeBigInt64BE=K((function(e,t=0){return x(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeFloatLE=function(e,t,r){return N(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return N(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return R(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return R(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(!s.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);const i=n-r;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;let i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{const o=s.isBuffer(e)?e:s.from(e,n),a=o.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=o[i%a]}return this};const M={};function P(e,t,r){M[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function D(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function F(e,t,r,n,i,s){if(e>r||e<t){const n="bigint"==typeof t?"n":"";let i;throw i=s>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(s+1)}${n}`:`>= -(2${n} ** ${8*(s+1)-1}${n}) and < 2 ** ${8*(s+1)-1}${n}`:`>= ${t}${n} and <= ${r}${n}`,new M.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,r){$(t,"offset"),void 0!==e[t]&&void 0!==e[t+r]||H(t,e.length-(r+1))}(n,i,s)}function $(e,t){if("number"!=typeof e)throw new M.ERR_INVALID_ARG_TYPE(t,"number",e)}function H(e,t,r){if(Math.floor(e)!==e)throw $(e,r),new M.ERR_OUT_OF_RANGE(r||"offset","an integer",e);if(t<0)throw new M.ERR_BUFFER_OUT_OF_BOUNDS;throw new M.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}P("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),P("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),P("ERR_OUT_OF_RANGE",(function(e,t,r){let n=`The value of "${e}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=D(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=D(i)),i+="n"),n+=` It must be ${t}. Received ${i}`,n}),RangeError);const W=/[^+/0-9A-Za-z-_]/g;function j(e,t){let r;t=t||1/0;const n=e.length;let i=null;const s=[];for(let o=0;o<n;++o){if(r=e.charCodeAt(o),r>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&s.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&s.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&s.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;s.push(r)}else if(r<2048){if((t-=2)<0)break;s.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;s.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return s}function G(e){return Le(function(e){if((e=(e=e.split("=")[0]).trim().replace(W,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function z(e,t,r,n){let i;for(i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function V(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function q(e){return e!=e}const Y=function(){const e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)t[n+i]=e[r]+e[i]}return t}();function K(e){return"undefined"==typeof BigInt?J:e}function J(){throw new Error("BigInt not supported")}},Be(Ae={exports:{}},Ae.exports),Ae.exports);
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */const Ue=new TextEncoder,xe=new TextDecoder,Oe=Ne;function Ne(e,t=0){let r;if(void 0===e||"string"!=typeof e||"number"!=typeof t)throw TypeError("invlaid init variablie type name. ");return(e=e.toUpperCase()).includes("8")?(r=Ce.Buffer.alloc(1),e.includes("I")?r.writeInt8(t):r.writeUint8(t)):e.includes("16")?(r=Ce.Buffer.alloc(2),e.includes("I")?e.includes("L")?r.writeInt16LE(t):r.writeInt16BE(t):e.includes("L")?r.writeUint16LE(t):r.writeUint16BE(t)):e.includes("32")?(r=Ce.Buffer.alloc(4),e.includes("I")?e.includes("L")?r.writeInt32LE(t):r.writeInt32BE(t):e.includes("L")?r.writeUint32LE(t):r.writeUint32BE(t)):e.includes("F")?(r=Ce.Buffer.alloc(4),e.includes("L")?r.writeFloatLE(t):r.writeFloatBE(t)):e.includes("N")?r=Ce.Buffer.from(String(t)):console.log(`invalid type: ${e} or initvalue: ${t}`),r}const Re=Me;function Me(e,t,r){let n,i="B";if("number"==typeof t)"number"==typeof r?(n=Ce.Buffer.alloc(t),0!==r&&n.fill(r),i="B"):(n=Ce.Buffer.from(String(t)),i="N");else if("string"==typeof t&&"number"==typeof r)i=t.toUpperCase(),n=Ne(t,r);else if("string"==typeof t&&void 0===r)n=Ce.Buffer.from(t),i="S";else if(t instanceof Uint8Array&&void 0===r)n=t instanceof Ce.Buffer?t:Ce.Buffer.from(t);else if(t instanceof ArrayBuffer&&void 0===r)n=Ce.Buffer.from(t);else if(ArrayBuffer.isView(t))n=Ce.Buffer.from(t.buffer,t.byteOffset,t.byteLength);else if("object"==typeof t&&void 0===r)n=Ce.Buffer.from(JSON.stringify(t)),i="O";else{if("boolean"!=typeof t||void 0!==r)throw TypeError("invalid meta buffer type");{const e=t?1:0;n=Ce.Buffer.from([e]),i="!"}}return"string"==typeof e&&e.includes("#")&&(e=""),[e,i,n]}const Pe=De;function De(...e){let t=0;return e.map((e=>{const r=t++;return"number"==typeof e?Re(r,"N",e):Re(r,e)}))}function Fe(e){if((e=e.toUpperCase()).includes("8"))return e.includes("I")?"int8":"uint8";if(e.includes("16"))return e.includes("I")?e.includes("L")?"int16_le":"int16_be":e.includes("L")?"uint16_le":"uint16_be";if(e.includes("32"))return e.includes("I")?e.includes("L")?"int32_le":"int32_be":e.includes("L")?"uint32_le":"uint32_be";if(e.includes("F"))return e.includes("L")?"float_le":"float_be";if("B"===e)return"buffer";if("S"===e)return"string";if("N"===e)return"number";if("O"===e)return"object";if("!"===e)return"boolean";throw TypeError("invalid data type")}function $e(e,t,r,n){const i=Fe(e);if("int8"==i)return t.readInt8(r);if("uint8"===i)return t.readUint8(r);if("int16_le"===i)return t.readInt16LE(r);if("int16_be"===i)return t.readInt16BE(r);if("uint16_le"===i)return t.readUint16LE(r);if("uint16_be"===i)return t.readUint16BE(r);if("int32_le"===i)return t.readInt32LE(r);if("int32_be"===i)return t.readInt32BE(r);if("uint32_le"===i)return t.readUint32LE(r);if("uint32_be"===i)return t.readUint32BE(r);if("float_le"===i)return t.readFloatLE(r);if("float_be"===i)return t.readFloatBE(r);if("buffer"===i)return t.subarray(r,r+n);if("string"===i){const e=t.subarray(r,r+n);return xe.decode(e)}if("number"===i){const e=t.subarray(r,r+n);return Number(xe.decode(e))}if("object"!==i){if("boolean"===i)return 1===t.readInt8(r);throw TypeError("invalid data")}{const i=t.subarray(r,r+n);try{return JSON.parse(xe.decode(i))}catch(e){console.log("err. obj parse")}}}function He(...e){const t=function(e){let t=[];return e.filter((e=>{if(!Array.isArray(e[0]))return e;t=t.concat(e)})).concat(t)}(e);let r=0;const n=[];let i,s,o=0;if(t.forEach((e=>{const[t,i,s]=e;r+=s.byteLength,("number"==typeof t||t.length>0)&&n.push([t,i,o,s.byteLength]),o=r})),n.length>0){let e=JSON.stringify(n);i=Ue.encode(e),s=i.byteLength,r=r+s+2}const a=Ce.Buffer.alloc(r);if(o=0,t.forEach((e=>{const t=e[2];a.set(t,o),o+=t.byteLength})),n.length>0){a.set(i,o);const e=Oe("16",s);return a.set(e,o+s),a}return a}function We(e,t){const r=t||st(e);if(!r)return;const n=Ce.Buffer.from(e),i={};let s=0;if(r.forEach((e=>{const[t,r,o,a]=e;i[t]=$e(r,n,o,a),a&&(s+=a)})),t&&n.byteLength!==s){let e=n.byteLength-s;i.$OTHERS=$e("b",n,s,e)}let o=0,a=[];for(;i[o];)a.push(i[o++]);return a.length>0&&(i.args=a,i.$=i.args),i}const je=Ge;function Ge(e,t=!1){if(void 0===e)throw TypeError("Invalid data type: Undefined");if("string"==typeof e)return Ue.encode(e);if("number"==typeof e)return Uint8Array.from([e]);if(e instanceof ArrayBuffer){if(t)return new Uint8Array(e);{const t=new Uint8Array(e),r=new Uint8Array(e.byteLength);return r.set(t),r}}if(ArrayBuffer.isView(e)){if(t)return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);{const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=new Uint8Array(e.byteLength);return r.set(t),r}}return Ue.encode(JSON.stringify(e))}const ze=Ve;function Ve(e,t=!1){const r=Ge(e,t);return t?Ce.Buffer.from(r.buffer,r.byteOffset,r.byteLength):Ce.Buffer.from(r)}const qe=Ye;function Ye(...e){const t=e.map((e=>Ve(e)));return Ce.Buffer.concat(t)}const Ke=Je;function Je(...e){try{let t=0,r=0;const n=e.map((e=>Ge(e)));n.forEach((e=>{t+=e.byteLength}));const i=new Uint8Array(t);return n.forEach((e=>{i.set(e,r),r+=e.byteLength})),i}catch(e){console.log(e)}}function Qe(e){return Array.prototype.map.call(new Uint8Array(e),(e=>("00"+e.toString(16)).slice(-2))).join("")}function Xe(e,t){if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}function Ze(e){return 0===nt(e)?e.byteLength:e.byteLength-nt(e)-tt}function et(e,t){try{const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=r.byteLength-t-2,i=r.subarray(n,r.byteLength-2),s=xe.decode(i),o=JSON.parse(s);if(!Array.isArray(o)||!Array.isArray(o[0]))return;let a=o[0];if(!a)return;if(a.length<3)return;const[h,f,c]=a;if("string"!=typeof f||"number"!=typeof c)return;return o}catch(e){}}const tt=2;function rt(e){return e instanceof ArrayBuffer&&(e=Ce.Buffer.from(e)),e instanceof Uint8Array?e.byteLength<=tt?0:new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(e.byteLength-tt):0}function nt(e){if(e instanceof ArrayBuffer&&(e=Ce.Buffer.from(e)),e instanceof Uint8Array){const t=e.byteLength;if(t<=tt)return 0;const r=rt(e);return 0===r||r>t?0:et(e,r)?r:0}return 0}function it(e){const t=Ze(e);return e.subarray(0,t)}function st(e,t=!1){e instanceof ArrayBuffer&&(e=Ce.Buffer.from(e));const r=rt(e);if(0===r)return;let n=et(e,r);return n?t?(n.forEach((e=>{null==e[3]&&(e[1].includes("8")?e[3]=1:e[1].includes("16")?e[3]=2:e[1].includes("32")||e[1].includes("F")?e[3]=4:e[1].includes("!")&&(e[3]=1)),e[4]=Fe(e[1])})),n):n:void 0}function ot(...e){return it(He(...e))}function at(...e){return st(He(...e))}Object.freeze({__proto__:null,Buffer:Ce.Buffer,NB:Oe,numberBuffer:Ne,MB:Re,metaBuffer:Me,MBA:Pe,metaBufferArguments:De,parseTypeName:Fe,readTypedBuffer:$e,pack:He,unpack:We,U8:je,parseUint8Array:Ge,B8:ze,parseBuffer:Ve,B8pack:qe,parseBufferThenConcat:Ye,U8pack:Ke,parseUint8ThenConcat:Je,hex:Qe,equal:Xe,getBufferSize:Ze,parseMetaInfo:et,TAIL_LEN:tt,readTail:rt,getMetaSize:nt,getBuffer:it,getMeta:st,rawPack:ot,meta:at,metaDetail:function(...e){return st(He(...e),!0)},getMetaDetail:function(e){return st(e,!0)}}),ge.hash=function(e){return ge(je(e))},ge.hex=function(e){return Qe(ge.hash(e))},ge.hmac=function(e,t){return function(e,t){const r=new pe(e).update(t),n=r.digest();return r.clean(),n}(je(e),je(t))};const ht=Re;let ft={AUTH_REQ:176,AUTH_NONCE:177,AUTH_HMAC:178,AUTH_ACK:179,AUTH_FAIL:180,AUTH_EXT:181,ENC_PACK:182,ENC_E2E:183,ENC_488:184};for(let e in ft)ft[ft[e]]=e;const ct={AUTH_REQ:at(ht("header","8",0),ht("reserved","8",0)),AUTH_NONCE:at(ht("header","8",0),ht("unixTime","32L",0),ht("milTime","32L",0),ht("nonce",Ce.Buffer.alloc(4))),AUTH_HMAC:at(ht("header","8",0),ht("id8",Ce.Buffer.alloc(8)),ht("nonce",Ce.Buffer.alloc(4)),ht("hmac32",Ce.Buffer.alloc(32))),AUTH_ACK:at(ht("header","8",0),ht("hmac32",Ce.Buffer.alloc(32))),ENC_PACK:at(ht("type","8",0),ht("len","32L",0),ht("salt12",Ce.Buffer.alloc(12)),ht("hmac",8,0)),ENC_488:at(ht("type","8",0),ht("len","32L",0),ht("otpSrc8",Ce.Buffer.alloc(8)),ht("hmac8",Ce.Buffer.alloc(8)))};function ut(e){let t=e[e.length-1];return t[2]+t[3]}const lt={AUTH_REQ:ut(ct.AUTH_REQ),AUTH_NONCE:ut(ct.AUTH_NONCE),AUTH_HMAC:ut(ct.AUTH_HMAC),AUTH_ACK:ut(ct.AUTH_ACK),ENC_PACK:ut(ct.ENC_PACK),ENC_488:ut(ct.ENC_488)};let dt=!1;try{dt="[object process]"===Object.prototype.toString.call(global.process)}catch(e){}function pt(e){return dt?t.webcrypto.getRandomValues(Ce.Buffer.alloc(e)):self.crypto.getRandomValues(Ce.Buffer.alloc(e))}class gt{constructor(){this._id8=Ce.Buffer.alloc(8),this._otpSrc44=Ce.Buffer.alloc(44),this._otp36=Ce.Buffer.alloc(36),this._hmac=Ce.Buffer.alloc(32),this.auth_salt12=Ce.Buffer.alloc(12),this.localNonce=Ce.Buffer.alloc(4),this.remoteNonce=Ce.Buffer.alloc(4),this.isAuthorized=!1}set_id8(e){let t=ze(e);this._id8.fill(0),t.copy(this._id8,0,0,8)}set_hash_id8(e){ze(ge.hash(e)).copy(this._id8,0,0,8)}set_key(e){ze(ge.hash(e)).copy(this._otpSrc44,0,0,32)}copy_id8(e){e.copy(this._id8,0,0,8)}copy_key(e){e.copy(this._otpSrc44,0,0,32)}sha256_n(e,t){let r=ge.hash(e);for(let e=0;e<t;e++)r=ge.hash(r);return r}set_clock_rand(){let e=Date.now(),t=parseInt(e/1e3);e%=4294967295,Ce.Buffer.concat([Oe("32L",t),Oe("32L",e),pt(4)]).copy(this._otpSrc44,32)}set_clock_nonce(e){let t=Date.now(),r=parseInt(t/1e3);t%=4294967295,Ce.Buffer.concat([Oe("32L",r),Oe("32L",t),e]).copy(this._otpSrc44,32)}set_salt12(e){e.copy(this._otpSrc44,32)}resetOTP(){ze(ge.hash(this._otpSrc44)).copy(this._otp36,0,0,32)}getIndexOTP(e){return this._otp36.writeUInt32LE(e,32),ge.hash(this._otp36)}generateHMAC(e){let t=Ce.Buffer.concat([this._otpSrc44,e]);this._hmac=ze(ge.hash(t))}getHMAC8(e){let t=Ce.Buffer.concat([this._otpSrc44,e]);return this._hmac=ze(ge.hash(t)),this._hmac.subarray(0,8)}xotp(e,t=0,r=!1){let n=(e=ze(e,r)).byteLength,i=t,s=0,o=0;for(;n>0;){o=n<32?n:32;let t=this.getIndexOTP(++i);for(let r=0;r<o;r++)e[s++]^=t[r];n-=32}return e}auth_req(){return He(Re("#type","8",ft.AUTH_REQ),Re("#reserved","8",0))}auth_nonce(){let e=Date.now(),t=Math.floor(e/1e3),r=e%1e3;return this.localNonce=pt(4),this.auth_salt12=Ce.Buffer.concat([Oe("32L",t),Oe("32L",r),this.localNonce]),Ce.Buffer.concat([Oe("8",ft.AUTH_NONCE),this.auth_salt12])}auth_hmac(e){let t=We(e,ct.AUTH_NONCE);if(t){let e=Ce.Buffer.concat([Oe("32L",t.unixTime),Oe("32L",t.milTime),t.nonce]);return this.set_salt12(e),this.localNonce=pt(4),this.generateHMAC(this.localNonce),this.remoteNonce=t.nonce,He(Re("#header","8",ft.AUTH_HMAC),Re("#id8",this._id8),Re("#nonce",this.localNonce),Re("#hmac32",this._hmac))}return!1}check_auth_hmac(e){let t;if(e instanceof Uint8Array){if(t=We(e,ct.AUTH_HMAC),!t)return}else t=e;this.set_salt12(this.auth_salt12),this.generateHMAC(t.nonce);let r=this._hmac;if(Xe(t.hmac32,r)){this.remoteNonce=t.nonce;let e=Ce.Buffer.concat([this.localNonce,this.remoteNonce,this.localNonce]);this.set_salt12(e),this.generateHMAC(t.nonce);let r=this._hmac,n=ot(Re("header","8",ft.AUTH_ACK),Re("hmac32",r));return this.isAuthorized=!0,n}return!1}check_auth_ack_hmac(e){let t=We(e,ct.AUTH_ACK);if(t){let e=Ce.Buffer.concat([this.remoteNonce,this.localNonce,this.remoteNonce]);if(this.set_salt12(e),this.generateHMAC(this.localNonce),Xe(this._hmac,t.hmac32))return this.isAuthorized=!0,!0}}encrypt_488(e){if(!this.isAuthorized)return;e=ze(e),this.set_clock_nonce(this.remoteNonce),this.resetOTP();let t=this.getHMAC8(e),r=this.xotp(e);return He(Re("#type","8",ft.ENC_488),Re("#len","32L",e.byteLength),Re("#otpSrc8",this._otpSrc44.subarray(32,40)),Re("#hmac8",t),Re("#xdata",r))}decrypt_488(e){let t=We(e=ze(e),ct.ENC_488);if(t){let e=Ce.Buffer.concat([t.otpSrc8,this.localNonce]);this.set_salt12(e),this.resetOTP();let r=t.$OTHERS.subarray(0,t.len),n=this.xotp(r);if(Xe(this.getHMAC8(n),t.hmac8))return n}}encryptPack(e){e=ze(e),this.set_clock_rand(),this.resetOTP();let t=this.getHMAC8(e),r=this.xotp(e);return He(Re("#type","8",ft.ENC_PACK),Re("#len","32L",e.byteLength),Re("#salt12",this._otpSrc44.subarray(32)),Re("#hmac8",t),Re("#xdata",r))}decryptPack(e){if(e[0]===ft.ENC_PACK&&e.readUint32LE(1)==e.byteLength-lt.ENC_PACK)try{let t=We(e,ct.ENC_PACK);if(!t)return;this.set_salt12(t.salt12),this.resetOTP();let r=t.$OTHERS,n=this.xotp(r),i=this.getHMAC8(n);if(Xe(t.hmac,i))return t.data=n,t}catch(e){}}encrypt_e2e(e,t){let r=Ce.Buffer.alloc(32);r.set(this._otpSrc44.subarray(0,32)),this.set_key(t);let n=this.encryptPack(e);return this._otpSrc44.set(r),n}decrypt_e2e(e,t){let r=Ce.Buffer.alloc(32);r.set(this._otpSrc44.subarray(0,32)),this.set_key(t);let n=this.decryptPack(e);return this._otpSrc44.set(r),n}}Ce.Buffer;let yt={NO:0,YES:1,AUTO:2};for(let e in yt)yt[yt[e]]=e;const _t={TAG_LEN1:255,TAG_LEN2:65535};let mt={EMPTY:0,STRING:1,BUFFER:2,OBJECT:3,MJSON:4,MBA:5};for(let e in mt)mt[mt[e]]=e;let bt={ADMIN_REQ:160,ADMIN_ACK:161,SERVER_READY:192,CID_REQ:193,CID_ACK:194,LOOP:203,ECHO:204,PING:205,PONG:206,CLOSE:207,SIGNAL:208,SIGNAL_REQ:209,SIGNAL_E2E:210,SUBSCRIBE:211,SUBSCRIBE_REQ:212,UNSUBSCRIBE:213,IAM:217,IAM_ACK:218,SET:219,RESPONSE_CODE:220,RESPONSE_MBP:221,REQUEST:222,RESPONSE:223,FLOW_MODE:240,WAIT:241,RESUME:242,TIME_OUT:253,OVER_SIZE:254,OVER_FLOW:255};for(let e in bt)bt[bt[e]]=e;const wt={IAM_ACK:function(...e){return ne(X(...e))}(Y("header","8",0))},Et=new TextDecoder,vt=V,St=Y;class Bt{constructor(e,t){this.socket=e,e.isAlive=!0,e.txCounter=0,e.rxCounter=0,e.openTime=Date.now(),this.boho=new gt,this.encMode=yt.AUTO,this.channels=new Set,this.memory=new Map,this.ssid=Bt.getID(),console.log("ssid",this.ssid),this.manager=t,this.cid,this.did,this.nick,this.adminLevel=0,this.lastEchoMessage="N",this.privateNode=!1,this.HOME_CHANNEL=""}static ssid=1;static getID(){return Bt.ssid++}showMessageLog(e,t){let r=this.boho.isAuthorized?`did: ${this.did} ( ${this.cid}) `:"";if(t){let t=bt[e[0]];t||(t=ft[e[0]]),t="[SHOW_MESSAGE][ "+t+" ]",e.byteLength>40?console.log(t+r+" LEN:",e.length):console.log(t+r,e)}else console.log(r+"[SHOW_MESSAGE][ STR ] %s",e)}onSocketMessage(e,r=!0){let n,i;if(this.receiveMonitor(),"message"===ce.showMessage&&this.showMessageLog(e,r),r){if(n=e[0],n===ft.ENC_488){let t=this.boho.isAuthorized?this.cid:"anonymous";console.log(`>> [E488] from: ${t} LEN ${e.byteLength}`);try{i=this.boho.decrypt_488(e)}catch(e){return void console.log("-- E488 DEC_FAIL",e)}if(!i)return;n=i[0],e=i}else if(n===ft.ENC_E2E){try{i=this.boho.decrypt_488(e)}catch(e){return void console.log("-- E2E DEC_FAIL",e)}if(!i)return;n=i[0],e.set(i,lt.ENC_488),e=e.subarray(lt.ENC_488)}switch(n){case bt.PING:console.log("ping from:",this.cid),this.pong();break;case bt.PONG:break;case bt.CID_REQ:this.cid||(this.cid=t.webcrypto.getRandomValues(Buffer.alloc(6)).toString("base64"),this.manager.cid_map.set(this.cid,this)),console.log("<< SENDING CID_ACK:",this.cid),this.send_enc_mode(X(St("#response_cid","8",bt.CID_ACK),St("#cid",this.cid)));break;case bt.ECHO:try{let t=Et.decode(e.subarray(1));this.lastEchoMessage=t}catch(e){}this.send(e,r);break;case bt.LOOP:let i=e.subarray(1);this.send(i,r);break;case bt.IAM:if(e.byteLength>1){let t=e.subarray(1);this.nick=Et.decode(t),console.log("iam nick reset",this.nick)}this.iamResponse();break;case bt.SIGNAL_E2E:case bt.SIGNAL:if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength>=t+2){let r=e.subarray(2,2+t);if(r=Et.decode(r),r.includes("$")){let n,i,s,o;if(r.indexOf("#")>2?(n=r.substring(0,r.indexOf("#")),i=r.substring(r.indexOf("#")),console.log("setkey for tag",n)):r.indexOf("@")>2&&(n=r.substring(0,r.indexOf("@")),i=r.substring(r.indexOf("@")),console.log("setkey for cid",n)),o=this.memory.get(n)){s=o+i;let r=e.subarray(2+t),n=Buffer.alloc(2+s.length);n[0]=e[0],n[1]=s.length;let a=Buffer.from(s);n.set(a,2);let h=Buffer.concat([n,r]);this.manager.sender(s,this,h,!0);break}}this.manager.sender(r,this,e,!0)}}break;case bt.SIGNAL_REQ:if(e.byteLength>=6){let t=e.readUInt16BE(1),n=e.readUInt8(3);if(e.byteLength>=n+4){let i=e.subarray(4,4+n);i=Et.decode(i);let s,[o,a]=this.manager.sender(i,this,e,r),h=0;"ok"==o?s=X(St("receiver","8",a)):(s=X(St("result",a)),h=255),this.response(t,h,s)}}break;case bt.UNSUBSCRIBE:if(2==e.byteLength)this.manager.unsubscribe([""],this);else if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength==t+2){let r=e.subarray(2,2+t);r=Et.decode(r);let n=r.split(",");this.manager.unsubscribe(n,this)}}break;case bt.SET:if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength==t+2){let r=e.subarray(2,2+t);r=Et.decode(r),r.split(",").forEach(((e,t)=>{if(0==e.indexOf("$")&&e.includes("=")){let t=e.substring(0,e.indexOf("=")),r=e.substring(e.indexOf("=")+1);if(t&&r){let e=3;this.memory.size<e?this.memory.set(t,r):this.memory.has(t)?(console.log("this.memory come to sizelimit. but change value is allowed"),this.memory.set(t,r)):console.log("this.memory size over. no addition allowed, change is okay.",this.memory.size)}else t&&""==r&&(console.log("delete memory key",t),this.memory.delete(t))}})),console.log(">> SET memory:",this.memory)}}break;case bt.SUBSCRIBE:if(e.byteLength>=3){let t=e.readUInt8(1);if(e.byteLength==t+2){let r=e.subarray(2,2+t);r=Et.decode(r);let n=r.split(",");console.log("SUBSCRIBE req splittagList",n),this.manager.subscribe(n,this)}}break;case bt.SUBSCRIBE_REQ:if(e.byteLength>=6){let t=e.readUInt16BE(1),r=e.readUInt16BE(3);if(e.byteLength==r+5){let n=e.subarray(5,5+r);n=Et.decode(n);let i=n.split(",");console.log(">> SUBSCRIBE_REQ from:",this.cid,i);let s=this.manager.subscribe(i,this);this.response(t,s)}else this.response(t,255)}break;case bt.REQUEST:if(e.byteLength>=6){let t=e.readUInt16BE(1),r=e.readUInt8(3);if(e.byteLength==r+4){let n=Et.decode(e.subarray(4,4+r));if(console.log(">> REQUEST tag from:",n,this.cid),!this.manager.authManager)return;this.manager.authManager.getPublic(n).then((e=>{console.log("public info",e),e?this.response(t,0,X(St("req",n),St("result",e))):this.response(t,0,X(St("req",n),St("result","NOP")))})).catch((e=>{this.response(t,255)}))}else this.response(t,255)}break;case bt.CLOSE:if(e.byteLength>1){let t=Et.decode(e.subarray(1));console.log(">> CLOSE reason:",t),this.close()}break;case ft.AUTH_REQ:let s=this.boho.auth_nonce();console.log("auth_nonce_pack",s),this.send(s),this.boho.isAuthorized&&console.log("already login.  relogin.");break;case ft.AUTH_HMAC:if(!this.manager.authManager)return;return void this.manager.authManager.verify_auth_hmac(e,this);case bt.ADMIN:break;default:console.log("unknown binary from,cmd,msg:",this.cid,n,e)}}}response(e,t,r=new Uint8Array(0)){let n=Buffer.concat([vt("8",bt.RESPONSE_MBP),vt("8",t),vt("16",e),r]);this.send(n)}send_enc_mode(e,t=!1){if((this.encMode===yt.YES||this.encMode===yt.AUTO&&!this.TLS&&this.boho.isAuthorized)&&(t=!0),t&&e[0]==bt.SIGNAL_E2E){let t=e[1],r=this.boho.encrypt_488(e.subarray(0,3+t));r[0]=ft.ENC_E2E;let n=Buffer.concat([r,e.subarray(3+t)]);this.send(n)}else if(t){let t=this.boho.encrypt_488(e);t?this.send(t):console.log("encryption FAIL: NO DATA TRANSIT")}else this.send(e)}iamResponse(e=""){if(""==e){let t=[];for(let e of this.channels.keys())t.push(e);e={cid:this.cid,ssid:this.ssid,userid:this.did,nick:this.nick,ip:this.ip,tag:t}}let t=X(St("#MsgType","8",bt.IAM_ACK),St("#info",e));this.send_enc_mode(t)}}class At extends Bt{constructor(e,t,r){super(e,r),e.isWS?(this.isWS=!0,this.TLS="https"===t.headers["x-forwarded-proto"],this.ip=this.getClientIP(t)):(this.TLS=!1,this.ip=this.getClientIP(e.remoteAddress)),!function(e){if(0===e.indexOf("0.0.0.0"))return!0;if(0===e.indexOf("127.0.0.1"))return!0;if(0===e.indexOf("192.168."))return!0;if(0===e.indexOf("10."))return!0;if(0===e.indexOf("172.")){if(0===e.indexOf("172.16."))return!0;if(0===e.indexOf("172.17."))return!0;if(0===e.indexOf("172.18."))return!0;if(0===e.indexOf("172.19."))return!0;if(0===e.indexOf("172.20."))return!0;if(0===e.indexOf("172.21."))return!0;if(0===e.indexOf("172.22."))return!0;if(0===e.indexOf("172.23."))return!0;if(0===e.indexOf("172.24."))return!0;if(0===e.indexOf("172.25."))return!0;if(0===e.indexOf("172.26."))return!0;if(0===e.indexOf("172.27."))return!0;if(0===e.indexOf("172.28."))return!0;if(0===e.indexOf("172.29."))return!0;if(0===e.indexOf("172.30."))return!0;if(0===e.indexOf("172.31."))return!0}return!1}(this.ip)?this.HOME_CHANNEL=this.manager.getGlobalIPChannel(this):(this.HOME_CHANNEL=this.manager.getPrivateChannel(this),this.privateNode=!0),this.isWS?(e.on("message",this.onSocketMessage.bind(this)),e.on("pong",this.receiveMonitor.bind(this)),e.on("ping",this.receiveMonitor.bind(this)),e.on("error",(e=>{console.log("Websocket error",e,e.code)})),e.onclose=e=>{console.log("websocket closed"),this.manager.removeClient(this)}):(this.congRx=new fe,e.pipe(this.congRx),this.congRx.on("data",this.onSocketMessage.bind(this)),e.on("error",(e=>{console.log("TCP Socket error",e)})),e.on("close",(e=>{console.log("tcp socket closed"),this.manager.removeClient(this)})))}permissionChecker(){let e=this.socket.bytesWritten||this.socket._socket?.bytesWritten,t=this.socket.bytesRead||this.socket._socket?.bytesRead;null==e&&(e=0),null==t&&(t=0),!this.boho.isAuthorized&&e+t>100&&(console.log("limit over."),this.close())}receiveMonitor(){this.socket.rxCounter++,this.socket.isAlive=!0}isConnectionHTTPS(e){return e.headers["x-forwarded-proto"]}getClientIP(e){let t;return e.headers?(t=e.headers["x-forwarded-for"],null==t&&(t=e.socket.remoteAddress)):t=e,t?(0==t.indexOf("::ffff:")&&(t=t.substring(7)),"::1"==t&&(t="127.0.0.1")):t="0.0.0.0",console.log("getClientIP",t),t}ping(){this.isWS?(this.socket.ping(),this.socket.txCounter++):this.send(Buffer.from([bt.PING]))}pong(){this.isWS?(this.socket.ping(),this.socket.txCounter++):this.send(Buffer.from([bt.PONG]))}close(){this.isWS?this.socket.terminate():this.socket.end()}send(e,t){this.socket.txCounter++,this.isWS?1===this.socket.readyState?null!=t?this.socket.send(e,{binary:t}):this.socket.send(e):console.log(" : ServerRemote::send(), WS not open. cid:",this.cid,e):"open"==this.socket.readyState?this.socket.write(he(e)):console.log(" : ServerRemote::send(), TCP socket not open: cid:",this.cid,e)}}process.on("uncaughtException",((e,t)=>{console.log("serverRemote::uncaughtException",e,t)}));class Lt{constructor(e){this.file=y.default.openSync(e,"a+"),console.log("new logFile",e,this.file)}log(e){let t=this.timeStamp()+" "+e+"\n";y.default.write(this.file,t,(e=>{if(e)throw e}))}timeStamp(){let e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}}class kt{constructor(e){this.manager=e,this.remocons=e.remocons,this.channel_map=e.channel_map,this.cid_map=e.cid_map}getRemotes(){return Array.from(this.manager.remocons.keys()).map((e=>e.cid))}getCIDList(){return Array.from(this.manager.cid_map.keys())}getChannelList(){return Array.from(this.channel_map.keys())}closeRemoteByCID(e){this.manager.cid_map.get(e)}}class It{constructor(e){this.authManager=e,ce.useLogger&&(this.logger=new Lt("manager.log"),console.log("manager logger",this.logger)),this.privateChannelName=t.webcrypto.getRandomValues(Buffer.alloc(15)).toString("base64"),this.publicIPChannelBaseName=t.webcrypto.getRandomValues(Buffer.alloc(15)).toString("base64"),this.remocons=new Set,this.channel_map=new Map,this.cid_map=new Map,this.admin=new kt(this),this.adminChannelIntervalID=null,this.adminMetricOption=0,this.pingIntervalID=setInterval((e=>{this.remocons.forEach((function(e){let t=e.socket;!1===t.isAlive&&(console.log("timeout."),e.isWS?t.terminate():t.end()),t.txCounter++,t.isAlive=!1,e.isWS?t.ping():e.ping()}))}),ce.pingTimeout),this.monitIntervalID=setInterval((e=>{ce.showMetric&&this.monitor()}),ce.monitorPeriod)}addClient(e,t){e.isAlive=!0,console.log("client type: "+(e.isWS?"WS":"TCP"));let r=new At(e,t,this);this.remocons.add(r),r.send(Buffer.from([bt.SERVER_READY])),this.logger&&this.logger.log(`+ ${e.isWS?"WS":"TCP"} ${r.ip}`)}removeClient(e){for(let t of e.channels.keys())if(this.channel_map.has(t)){const r=this.channel_map.get(t);console.log(`-- channel [ ${t} ] removes client id: ${e.cid} `),r.delete(e),0==r.size&&this.channel_map.delete(t)}this.remocons.delete(e),this.cid_map.delete(e.cid),console.log("-- a client will be removed:",e.cid),e=null}sender(e,t,r,n){if("sudo:channels"==e){let t=this.admin.getChannelList();return void console.log(e,t)}if("sudo:remocons"==e){let t=this.admin.getRemotes();return void console.log(e,t)}if("sudo:cid"==e){let t=this.admin.getCIDList();return void console.log(e,t)}console.log("-- chMan.sender tag:",e);let i=0;if(e.includes("#")&&""==e.split("#")[0])e=t.HOME_CHANNEL+e;else{if(e.includes("@")){let n=e.split("@")[0];return this.cid_map.has(n)?(console.log("<< unicast to: ",n,"<= from:",t.cid," len: ",r.byteLength),this.cid_map.get(n).send_enc_mode(r),["ok",1]):["err","Invalid node id"]}if(this.cid_map.has(e)){let t=1+r.readUInt8(1);return r[t]="@".charCodeAt(),this.cid_map.get(e).send_enc_mode(r),["ok",1]}}if(console.log("cid_map: ",this.cid_map.keys()),this.channel_map.has(e)){console.log("sender tag",e);let n=this.channel_map.get(e);return n.size>=1&&(console.log("ch: "+e+" has clients:",n.size),n.forEach((e=>{e!==t&&(e.send_enc_mode(r),i++)}))),["ok",i]}return console.log("no one subscribed ch: ",e),["err","No one subscribed."]}getPrivateChannel(e){return"PIP:"+this.privateChannelName}getGlobalIPChannel(e){return"GIP:"+e.ip+this.publicIPChannelBaseName}subscribe(e,t){return e.forEach((e=>{e.includes("#")&&""==e.split("#")[0]&&(e=t.HOME_CHANNEL+e),this.channel_map.has(e)?this.channel_map.get(e).add(t):this.channel_map.set(e,new Set([t])),t.channels.add(e)})),t.channels.size}unsubscribe(e,t){1==e.length&&""==e[0]?(t.channels.forEach((e=>{if(this.channel_map.has(e)){let r=this.channel_map.get(e);r.delete(t),0==r.size&&this.channel_map.delete(e)}})),t.channels.clear()):e.forEach((e=>{if(e.includes("#")&&""==e.split("#")[0]&&(e=t.HOME_CHANNEL+e),console.log("Manager::unsubscribe:",e),this.channel_map.has(e)){let r=this.channel_map.get(e);r.delete(t),0==r.size&&this.channel_map.delete(e)}else console.log("no sub ch",e);t.channels.delete(e)})),console.log("result unsub:",t.channels)}monitor(){let e=[];this.cid_map.forEach(((t,r)=>{e.push({cid_key:r,cid:t.cid,ssid:t.ssid,uptime:Math.trunc((Date.now()-t.socket.openTime)/1e3),isSecure:t.isSecureLine,isAuth:t.boho.isAuthorized,encMode:yt[t.encMode]})}));let t=Array.from(this.remocons.keys()).map((e=>({cid:e.cid,ssid:e.ssid,uptime:Math.trunc((Date.now()-e.socket.openTime)/1e3),isSecure:e.isSecureLine,isAuth:e.boho.isAuthorized,encMode:yt[e.encMode]})));console.log("\n\ncid_map:"),console.table(e,["cid_key","cid","ssid","uptime","isSecure","isAuth","encMode"]),console.log("remocons_set:"),console.table(t,["cid","ssid","uptime","isSecure","isAuth","encMode"])}adminChannelBroadCast(){let e={};e.channels=this.getMetric(this.adminMetricOption),e.time=Date.now(),e.timeStamp=L();let t=["pub","admin",e];this.sender(ce.adminChannel,"",JSON.stringify(t))}adminResponse(e){let t={};t.channels=this.getMetric(this.adminMetricOption),t.time=Date.now(),t.timeStamp=L();let r=["pub","admin",t];this.sender(ce.adminChannel,"",JSON.stringify(r))}getMetric(e=0){let t,r=[];if(0==e?t=this.remocons:1==e||(t=this.channel_map.get(e)),1==e)this.channel_map.forEach(((e,t)=>{let n=[];n=Array.from(e),n=n.map((e=>({ip:e.ip,ssid:e.ssid,id:e.cid,cid:e.cid,uptime:Math.trunc((Date.now()-e.socket.openTime)/1e3),tx:e.socket.txCounter,rx:e.socket.rxCounter,txBytes:e.socket.bytesWritten||e.socket._socket?.bytesWritten,rxBytes:e.socket.bytesRead||e.socket._socket?.bytesRead})));let i={name:t,clients:n};r.push(i)}));else{let n=[];if(!t)return[{name:"no channel",clients:[]}];n=Array.from(t),n=n.map((e=>({ip:e.ip,id:e.cid,ssid:e.ssid,nick:e.nick,uptime:Math.trunc((Date.now()-e.socket.openTime)/1e3),tx:e.socket.txCounter,rx:e.socket.rxCounter,txBytes:e.socket.bytesWritten||e.socket._socket?.bytesWritten,rxBytes:e.socket.bytesRead||e.socket._socket?.bytesRead})));let i={name:e,clients:n};r.push(i)}return r}}var Tt={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}},Ct="function"==typeof __webpack_require__?__non_webpack_require__:I,Ut=process.config&&process.config.variables||{},xt=!!process.env.PREBUILDS_ONLY,Ot=process.versions.modules,Nt=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":process.versions&&process.versions.nw?"node-webkit":"node",Rt=process.env.npm_config_arch||w.default.arch(),Mt=process.env.npm_config_platform||w.default.platform(),Pt=process.env.LIBC||(function(e){return"linux"===e&&y.default.existsSync("/etc/alpine-release")}(Mt)?"musl":"glibc"),Dt=process.env.ARM_VERSION||("arm64"===Rt?"8":Ut.arm_version)||"",Ft=(process.versions.uv||"").split(".")[0],$t=Ht;function Ht(e){return Ct(Ht.path(e))}function Wt(e){try{return y.default.readdirSync(e)}catch(e){return[]}}function jt(e,t){var r=Wt(e).filter(t);return r[0]&&b.default.join(e,r[0])}function Gt(e){return/\.node$/.test(e)}function zt(e){var t=e.split("-");if(2===t.length){var r=t[0],n=t[1].split("+");if(r&&n.length&&n.every(Boolean))return{name:e,platform:r,architectures:n}}}function Vt(e,t){return function(r){return null!=r&&(r.platform===e&&r.architectures.includes(t))}}function qt(e,t){return e.architectures.length-t.architectures.length}function Yt(e){var t=e.split("."),r={file:e,specificity:0};if("node"===t.pop()){for(var n=0;n<t.length;n++){var i=t[n];if("node"===i||"electron"===i||"node-webkit"===i)r.runtime=i;else if("napi"===i)r.napi=!0;else if("abi"===i.slice(0,3))r.abi=i.slice(3);else if("uv"===i.slice(0,2))r.uv=i.slice(2);else if("armv"===i.slice(0,4))r.armv=i.slice(4);else{if("glibc"!==i&&"musl"!==i)continue;r.libc=i}r.specificity++}return r}}function Kt(e,t){return function(r){return null!=r&&(!(r.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(r))&&(!(r.abi!==t&&!r.napi)&&((!r.uv||r.uv===Ft)&&((!r.armv||r.armv===Dt)&&(!r.libc||r.libc===Pt)))))}}function Jt(e){return function(t,r){return t.runtime!==r.runtime?t.runtime===e?-1:1:t.abi!==r.abi?t.abi?-1:1:t.specificity!==r.specificity?t.specificity>r.specificity?-1:1:0}}Ht.path=function(e){e=b.default.resolve(e||".");try{var t=Ct(b.default.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!xt){var r=jt(b.default.join(e,"build/Release"),Gt);if(r)return r;var n=jt(b.default.join(e,"build/Debug"),Gt);if(n)return n}var i=a(e);if(i)return i;var s=a(b.default.dirname(process.execPath));if(s)return s;var o=["platform="+Mt,"arch="+Rt,"runtime="+Nt,"abi="+Ot,"uv="+Ft,Dt?"armv="+Dt:"","libc="+Pt,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+o+"\n    loaded from: "+e+"\n");function a(e){var t=Wt(b.default.join(e,"prebuilds")).map(zt).filter(Vt(Mt,Rt)).sort(qt)[0];if(t){var r=b.default.join(e,"prebuilds",t.name),n=Wt(r).map(Yt).filter(Kt(Nt,Ot)).sort(Jt(Nt))[0];return n?b.default.join(r,n.file):void 0}}},Ht.parseTags=Yt,Ht.matchTags=Kt,Ht.compareTags=Jt,Ht.parseTuple=zt,Ht.matchTuple=Vt,Ht.compareTuples=qt;var Qt={mask:(e,t,r,n,i)=>{for(var s=0;s<i;s++)r[n+s]=e[s]^t[3&s]},unmask:(e,t)=>{const r=e.length;for(var n=0;n<r;n++)e[n]^=t[3&n]}},Xt=k((function(e){try{e.exports=$t(__dirname)}catch(t){e.exports=Qt}})),Zt=k((function(e){const{EMPTY_BUFFER:t}=Tt;function r(e,t,r,n,i){for(let s=0;s<i;s++)r[n+s]=e[s]^t[3&s]}function n(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(e.exports={concat:function(e,r){if(0===e.length)return t;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(r);let i=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,i),i+=r.length}return i<r?n.slice(0,i):n},mask:r,toArrayBuffer:function(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=Buffer.from(t):ArrayBuffer.isView(t)?r=Buffer.from(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:n},!process.env.WS_NO_BUFFER_UTIL)try{const t=Xt;e.exports.mask=function(e,n,i,s,o){o<48?r(e,n,i,s,o):t.mask(e,n,i,s,o)},e.exports.unmask=function(e,r){e.length<32?n(e,r):t.unmask(e,r)}}catch(e){}}));const er=Symbol("kDone"),tr=Symbol("kRun");var rr=class{constructor(e){this[er]=()=>{this.pending--,this[tr]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[tr]()}[tr](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[er])}}};const{kStatusCode:nr}=Tt,ir=Buffer.from([0,0,255,255]),sr=Symbol("permessage-deflate"),or=Symbol("total-length"),ar=Symbol("callback"),hr=Symbol("buffers"),fr=Symbol("error");let cr;var ur=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!cr){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;cr=new rr(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[ar];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){cr.add((n=>{this._decompress(e,t,((e,t)=>{n(),r(e,t)}))}))}compress(e,t,r){cr.add((n=>{this._compress(e,t,((e,t)=>{n(),r(e,t)}))}))}_decompress(e,t,r){const n=this._isServer?"client":"server";if(!this._inflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?m.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=m.default.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[sr]=this,this._inflate[or]=0,this._inflate[hr]=[],this._inflate.on("error",pr),this._inflate.on("data",dr)}this._inflate[ar]=r,this._inflate.write(e),t&&this._inflate.write(ir),this._inflate.flush((()=>{const e=this._inflate[fr];if(e)return this._inflate.close(),this._inflate=null,void r(e);const i=Zt.concat(this._inflate[hr],this._inflate[or]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[or]=0,this._inflate[hr]=[],t&&this.params[`${n}_no_context_takeover`]&&this._inflate.reset()),r(null,i)}))}_compress(e,t,r){const n=this._isServer?"server":"client";if(!this._deflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?m.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=m.default.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[or]=0,this._deflate[hr]=[],this._deflate.on("data",lr)}this._deflate[ar]=r,this._deflate.write(e),this._deflate.flush(m.default.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=Zt.concat(this._deflate[hr],this._deflate[or]);t&&(e=e.slice(0,e.length-4)),this._deflate[ar]=null,this._deflate[or]=0,this._deflate[hr]=[],t&&this.params[`${n}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}};function lr(e){this[hr].push(e),this[or]+=e.length}function dr(e){this[or]+=e.length,this[sr]._maxPayload<1||this[or]<=this[sr]._maxPayload?this[hr].push(e):(this[fr]=new RangeError("Max payload size exceeded"),this[fr].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[fr][nr]=1009,this.removeListener("data",dr),this.reset())}function pr(e){this[sr]._inflate=null,e[nr]=1007,this[ar](e)}var gr=function(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0},yr=k((function(e){try{e.exports=$t(__dirname)}catch(t){e.exports=gr}})),_r=k((function(e){function t(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}if(e.exports={isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:t,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},!process.env.WS_NO_UTF_8_VALIDATE)try{const r=yr;e.exports.isValidUTF8=function(e){return e.length<150?t(e):r(e)}}catch(e){}}));const{Writable:mr}=_.default,{BINARY_TYPES:br,EMPTY_BUFFER:wr,kStatusCode:Er,kWebSocket:vr}=Tt,{concat:Sr,toArrayBuffer:Br,unmask:Ar}=Zt,{isValidStatusCode:Lr,isValidUTF8:kr}=_r;var Ir=class extends mr{constructor(e={}){super(),this._binaryType=e.binaryType||br[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[vr]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],n=t.length-e;e>=r.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),n),this._buffers[0]=r.slice(e)),e-=r.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,Tr(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[ur.extensionName])return this._loop=!1,Tr(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,Tr(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,Tr(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,Tr(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,Tr(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,Tr(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,Tr(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,Tr(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,Tr(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,Tr(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,Tr(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,Tr(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=wr;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&Ar(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[ur.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(Tr(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(r)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)}))}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?Sr(t,e):"arraybuffer"===this._binaryType?Br(Sr(t,e)):t,this.emit("message",r,!0)}else{const r=Sr(t,e);if(!this._skipUTF8Validation&&!kr(r))return this._loop=!1,Tr(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",r,!1)}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,wr),this.end();else{if(1===e.length)return Tr(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!Lr(t))return Tr(RangeError,`invalid status code ${t}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const r=e.slice(2);if(!this._skipUTF8Validation&&!kr(r))return Tr(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function Tr(e,t,r,n,i){const s=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(s,Tr),s.code=i,s[Er]=n,s}const{randomFillSync:Cr}=g.default,{EMPTY_BUFFER:Ur}=Tt,{isValidStatusCode:xr}=_r,{mask:Or,toBuffer:Nr}=Zt,Rr=Symbol("kByteLength"),Mr=Buffer.alloc(4);class Pr{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let r,n,i=!1,s=2,o=!1;t.mask&&(r=t.maskBuffer||Mr,t.generateMask?t.generateMask(r):Cr(r,0,4),o=0==(r[0]|r[1]|r[2]|r[3]),s=6),"string"==typeof e?n=t.mask&&!o||void 0===t[Rr]?(e=Buffer.from(e)).length:t[Rr]:(n=e.length,i=t.mask&&t.readOnly&&!o);let a=n;n>=65536?(s+=8,a=127):n>125&&(s+=2,a=126);const h=Buffer.allocUnsafe(i?n+s:s);return h[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(h[0]|=64),h[1]=a,126===a?h.writeUInt16BE(n,2):127===a&&(h[2]=h[3]=0,h.writeUIntBE(n,4,6)),t.mask?(h[1]|=128,h[s-4]=r[0],h[s-3]=r[1],h[s-2]=r[2],h[s-1]=r[3],o?[h,e]:i?(Or(e,r,h,s,n),[h]):(Or(e,r,e,0,n),[h,e])):[h,e]}close(e,t,r,n){let i;if(void 0===e)i=Ur;else{if("number"!=typeof e||!xr(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+r),i.writeUInt16BE(e,0),"string"==typeof t?i.write(t,2):i.set(t,2)}else i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0)}const s={[Rr]:i.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,i,!1,s,n]):this.sendFrame(Pr.frame(i,s),n)}ping(e,t,r){let n,i;if("string"==typeof e?(n=Buffer.byteLength(e),i=!1):(n=(e=Nr(e)).length,i=Nr.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[Rr]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,s,r]):this.sendFrame(Pr.frame(e,s),r)}pong(e,t,r){let n,i;if("string"==typeof e?(n=Buffer.byteLength(e),i=!1):(n=(e=Nr(e)).length,i=Nr.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[Rr]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,s,r]):this.sendFrame(Pr.frame(e,s),r)}send(e,t,r){const n=this._extensions[ur.extensionName];let i,s,o=t.binary?2:1,a=t.compress;if("string"==typeof e?(i=Buffer.byteLength(e),s=!1):(i=(e=Nr(e)).length,s=Nr.readOnly),this._firstFragment?(this._firstFragment=!1,a&&n&&n.params[n._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=i>=n._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),n){const n={[Rr]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:s,rsv1:a};this._deflating?this.enqueue([this.dispatch,e,this._compress,n,r]):this.dispatch(e,this._compress,n,r)}else this.sendFrame(Pr.frame(e,{[Rr]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:s,rsv1:!1}),r)}dispatch(e,t,r,n){if(!t)return void this.sendFrame(Pr.frame(e,r),n);const i=this._extensions[ur.extensionName];this._bufferedBytes+=r[Rr],this._deflating=!0,i.compress(e,r.fin,((e,t)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof n&&n(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t],n=r[r.length-1];"function"==typeof n&&n(e)}}else this._bufferedBytes-=r[Rr],this._deflating=!1,r.readOnly=!1,this.sendFrame(Pr.frame(t,r),n),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][Rr],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][Rr],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var Dr=Pr;const{kForOnEventAttribute:Fr,kListener:$r}=Tt,Hr=Symbol("kCode"),Wr=Symbol("kData"),jr=Symbol("kError"),Gr=Symbol("kMessage"),zr=Symbol("kReason"),Vr=Symbol("kTarget"),qr=Symbol("kType"),Yr=Symbol("kWasClean");class Kr{constructor(e){this[Vr]=null,this[qr]=e}get target(){return this[Vr]}get type(){return this[qr]}}Object.defineProperty(Kr.prototype,"target",{enumerable:!0}),Object.defineProperty(Kr.prototype,"type",{enumerable:!0});class Jr extends Kr{constructor(e,t={}){super(e),this[Hr]=void 0===t.code?0:t.code,this[zr]=void 0===t.reason?"":t.reason,this[Yr]=void 0!==t.wasClean&&t.wasClean}get code(){return this[Hr]}get reason(){return this[zr]}get wasClean(){return this[Yr]}}Object.defineProperty(Jr.prototype,"code",{enumerable:!0}),Object.defineProperty(Jr.prototype,"reason",{enumerable:!0}),Object.defineProperty(Jr.prototype,"wasClean",{enumerable:!0});class Qr extends Kr{constructor(e,t={}){super(e),this[jr]=void 0===t.error?null:t.error,this[Gr]=void 0===t.message?"":t.message}get error(){return this[jr]}get message(){return this[Gr]}}Object.defineProperty(Qr.prototype,"error",{enumerable:!0}),Object.defineProperty(Qr.prototype,"message",{enumerable:!0});class Xr extends Kr{constructor(e,t={}){super(e),this[Wr]=void 0===t.data?null:t.data}get data(){return this[Wr]}}Object.defineProperty(Xr.prototype,"data",{enumerable:!0});const Zr={addEventListener(e,t,r={}){for(const n of this.listeners(e))if(!r[Fr]&&n[$r]===t&&!n[Fr])return;let n;if("message"===e)n=function(e,r){const n=new Xr("message",{data:r?e:e.toString()});n[Vr]=this,tn(t,this,n)};else if("close"===e)n=function(e,r){const n=new Jr("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});n[Vr]=this,tn(t,this,n)};else if("error"===e)n=function(e){const r=new Qr("error",{error:e,message:e.message});r[Vr]=this,tn(t,this,r)};else{if("open"!==e)return;n=function(){const e=new Kr("open");e[Vr]=this,tn(t,this,e)}}n[Fr]=!!r[Fr],n[$r]=t,r.once?this.once(e,n):this.on(e,n)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[$r]===t&&!r[Fr]){this.removeListener(e,r);break}}};var en={CloseEvent:Jr,ErrorEvent:Qr,Event:Kr,EventTarget:Zr,MessageEvent:Xr};function tn(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}const{tokenChars:rn}=_r;function nn(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var sn={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,n,i=Object.create(null),s=!1,o=!1,a=!1,h=-1,f=-1,c=-1,u=0;for(;u<e.length;u++)if(f=e.charCodeAt(u),void 0===r)if(-1===c&&1===rn[f])-1===h&&(h=u);else if(0===u||32!==f&&9!==f){if(59!==f&&44!==f)throw new SyntaxError(`Unexpected character at index ${u}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${u}`);-1===c&&(c=u);const n=e.slice(h,c);44===f?(nn(t,n,i),i=Object.create(null)):r=n,h=c=-1}}else-1===c&&-1!==h&&(c=u);else if(void 0===n)if(-1===c&&1===rn[f])-1===h&&(h=u);else if(32===f||9===f)-1===c&&-1!==h&&(c=u);else if(59===f||44===f){if(-1===h)throw new SyntaxError(`Unexpected character at index ${u}`);-1===c&&(c=u),nn(i,e.slice(h,c),!0),44===f&&(nn(t,r,i),i=Object.create(null),r=void 0),h=c=-1}else{if(61!==f||-1===h||-1!==c)throw new SyntaxError(`Unexpected character at index ${u}`);n=e.slice(h,u),h=c=-1}else if(o){if(1!==rn[f])throw new SyntaxError(`Unexpected character at index ${u}`);-1===h?h=u:s||(s=!0),o=!1}else if(a)if(1===rn[f])-1===h&&(h=u);else if(34===f&&-1!==h)a=!1,c=u;else{if(92!==f)throw new SyntaxError(`Unexpected character at index ${u}`);o=!0}else if(34===f&&61===e.charCodeAt(u-1))a=!0;else if(-1===c&&1===rn[f])-1===h&&(h=u);else if(-1===h||32!==f&&9!==f){if(59!==f&&44!==f)throw new SyntaxError(`Unexpected character at index ${u}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${u}`);-1===c&&(c=u);let o=e.slice(h,c);s&&(o=o.replace(/\\/g,""),s=!1),nn(i,n,o),44===f&&(nn(t,r,i),i=Object.create(null),r=void 0),n=void 0,h=c=-1}}else-1===c&&(c=u);if(-1===h||a||32===f||9===f)throw new SyntaxError("Unexpected end of input");-1===c&&(c=u);const l=e.slice(h,c);return void 0===r?nn(t,l,i):(void 0===n?nn(i,l,!0):nn(i,n,s?l.replace(/\\/g,""):l),nn(t,r,i)),t}};const{randomBytes:on,createHash:an}=g.default,{URL:hn}=A.default,{BINARY_TYPES:fn,EMPTY_BUFFER:cn,GUID:un,kForOnEventAttribute:ln,kListener:dn,kStatusCode:pn,kWebSocket:gn,NOOP:yn}=Tt,{EventTarget:{addEventListener:_n,removeEventListener:mn}}=en,{format:bn,parse:wn}=sn,{toBuffer:En}=Zt,vn=Symbol("kAborted"),Sn=[8,13],Bn=["CONNECTING","OPEN","CLOSING","CLOSED"],An=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class Ln extends v.default{constructor(e,t,r){super(),this._binaryType=fn[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=cn,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=Ln.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),In(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){fn.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const n=new Ir({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation});this._sender=new Dr(e,this._extensions,r.generateMask),this._receiver=n,this._socket=e,n[gn]=this,e[gn]=this,n.on("conclude",Nn),n.on("drain",Rn),n.on("error",Mn),n.on("message",Dn),n.on("ping",Fn),n.on("pong",$n),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Wn),e.on("data",jn),e.on("end",Gn),e.on("error",zn),this._readyState=Ln.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=Ln.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[ur.extensionName]&&this._extensions[ur.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=Ln.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==Ln.CLOSED){if(this.readyState===Ln.CONNECTING){const e="WebSocket was closed before the connection was established";return xn(this,this._req,e)}this.readyState!==Ln.CLOSING?(this._readyState=Ln.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==Ln.CONNECTING&&this.readyState!==Ln.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===Ln.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Ln.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||cn,t,r)):On(this,e,r)}pong(e,t,r){if(this.readyState===Ln.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Ln.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||cn,t,r)):On(this,e,r)}resume(){this.readyState!==Ln.CONNECTING&&this.readyState!==Ln.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===Ln.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==Ln.OPEN)return void On(this,e,r);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[ur.extensionName]||(n.compress=!1),this._sender.send(e||cn,n,r)}terminate(){if(this.readyState!==Ln.CLOSED){if(this.readyState===Ln.CONNECTING){const e="WebSocket was closed before the connection was established";return xn(this,this._req,e)}this._socket&&(this._readyState=Ln.CLOSING,this._socket.destroy())}}}Object.defineProperty(Ln,"CONNECTING",{enumerable:!0,value:Bn.indexOf("CONNECTING")}),Object.defineProperty(Ln.prototype,"CONNECTING",{enumerable:!0,value:Bn.indexOf("CONNECTING")}),Object.defineProperty(Ln,"OPEN",{enumerable:!0,value:Bn.indexOf("OPEN")}),Object.defineProperty(Ln.prototype,"OPEN",{enumerable:!0,value:Bn.indexOf("OPEN")}),Object.defineProperty(Ln,"CLOSING",{enumerable:!0,value:Bn.indexOf("CLOSING")}),Object.defineProperty(Ln.prototype,"CLOSING",{enumerable:!0,value:Bn.indexOf("CLOSING")}),Object.defineProperty(Ln,"CLOSED",{enumerable:!0,value:Bn.indexOf("CLOSED")}),Object.defineProperty(Ln.prototype,"CLOSED",{enumerable:!0,value:Bn.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(Ln.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(Ln.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[ln])return t[dn];return null},set(t){for(const t of this.listeners(e))if(t[ln]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[ln]:!0})}})})),Ln.prototype.addEventListener=_n,Ln.prototype.removeEventListener=mn;var kn=Ln;function In(e,t,r,n){const i={protocolVersion:Sn[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(!Sn.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${Sn.join(", ")})`);let s;if(t instanceof hn)s=t,e._url=t.href;else{try{s=new hn(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}e._url=t}const o="wss:"===s.protocol,a="ws+unix:"===s.protocol;let h;if("ws:"===s.protocol||o||a?a&&!s.pathname?h="The URL's pathname is empty":s.hash&&(h="The URL contains a fragment identifier"):h='The URL\'s protocol must be one of "ws:", "wss:", or "ws+unix:"',h){const t=new SyntaxError(h);if(0===e._redirects)throw t;return void Tn(e,t)}const f=o?443:80,c=on(16).toString("base64"),u=o?S.default.request:B.default.request,l=new Set;let d,p;if(i.createConnection=o?Un:Cn,i.defaultPort=i.defaultPort||f,i.port=s.port||f,i.host=s.hostname.startsWith("[")?s.hostname.slice(1,-1):s.hostname,i.headers={...i.headers,"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":c,Connection:"Upgrade",Upgrade:"websocket"},i.path=s.pathname+s.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(d=new ur(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=bn({[ur.extensionName]:d.offer()})),r.length){for(const e of r){if("string"!=typeof e||!An.test(e)||l.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");l.add(e)}i.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(s.username||s.password)&&(i.auth=`${s.username}:${s.password}`),a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}if(i.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=o,e._originalHostOrSocketPath=a?i.socketPath:s.host;const t=n&&n.headers;if(n={...n,headers:{}},t)for(const[e,r]of Object.entries(t))n.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&i.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&s.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!o)&&(delete i.headers.authorization,delete i.headers.cookie,t||delete i.headers.host,i.auth=void 0)}i.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),p=e._req=u(i),e._redirects&&e.emit("redirect",e.url,p)}else p=e._req=u(i);i.timeout&&p.on("timeout",(()=>{xn(e,p,"Opening handshake has timed out")})),p.on("error",(t=>{null===p||p[vn]||(p=e._req=null,Tn(e,t))})),p.on("response",(s=>{const o=s.headers.location,a=s.statusCode;if(o&&i.followRedirects&&a>=300&&a<400){if(++e._redirects>i.maxRedirects)return void xn(e,p,"Maximum redirects exceeded");let s;p.abort();try{s=new hn(o,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${o}`);return void Tn(e,r)}In(e,s,r,n)}else e.emit("unexpected-response",p,s)||xn(e,p,`Unexpected server response: ${s.statusCode}`)})),p.on("upgrade",((t,r,n)=>{if(e.emit("upgrade",t),e.readyState!==Ln.CONNECTING)return;if(p=e._req=null,"websocket"!==t.headers.upgrade.toLowerCase())return void xn(e,r,"Invalid Upgrade header");const s=an("sha1").update(c+un).digest("base64");if(t.headers["sec-websocket-accept"]!==s)return void xn(e,r,"Invalid Sec-WebSocket-Accept header");const o=t.headers["sec-websocket-protocol"];let a;if(void 0!==o?l.size?l.has(o)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":l.size&&(a="Server sent no subprotocol"),a)return void xn(e,r,a);o&&(e._protocol=o);const h=t.headers["sec-websocket-extensions"];if(void 0!==h){if(!d){return void xn(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=wn(h)}catch(t){return void xn(e,r,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(t);if(1!==n.length||n[0]!==ur.extensionName){return void xn(e,r,"Server indicated an extension that was not requested")}try{d.accept(t[ur.extensionName])}catch(t){return void xn(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[ur.extensionName]=d}e.setSocket(r,n,{generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})})),p.end()}function Tn(e,t){e._readyState=Ln.CLOSING,e.emit("error",t),e.emitClose()}function Cn(e){return e.path=e.socketPath,p.default.connect(e)}function Un(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=p.default.isIP(e.host)?"":e.host),E.default.connect(e)}function xn(e,t,r){e._readyState=Ln.CLOSING;const n=new Error(r);Error.captureStackTrace(n,xn),t.setHeader?(t[vn]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(Tn,e,n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function On(e,t,r){if(t){const r=En(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} (${Bn[e.readyState]})`))}}function Nn(e,t){const r=this[gn];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[gn]&&(r._socket.removeListener("data",jn),process.nextTick(Hn,r._socket),1005===e?r.close():r.close(e,t))}function Rn(){const e=this[gn];e.isPaused||e._socket.resume()}function Mn(e){const t=this[gn];void 0!==t._socket[gn]&&(t._socket.removeListener("data",jn),process.nextTick(Hn,t._socket),t.close(e[pn])),t.emit("error",e)}function Pn(){this[gn].emitClose()}function Dn(e,t){this[gn].emit("message",e,t)}function Fn(e){const t=this[gn];t.pong(e,!t._isServer,yn),t.emit("ping",e)}function $n(e){this[gn].emit("pong",e)}function Hn(e){e.resume()}function Wn(){const e=this[gn];let t;this.removeListener("close",Wn),this.removeListener("data",jn),this.removeListener("end",Gn),e._readyState=Ln.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[gn]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",Pn),e._receiver.on("finish",Pn))}function jn(e){this[gn]._receiver.write(e)||this.pause()}function Gn(){const e=this[gn];e._readyState=Ln.CLOSING,e._receiver.end(),this.end()}function zn(){const e=this[gn];this.removeListener("error",zn),this.on("error",yn),e&&(e._readyState=Ln.CLOSING,this.destroy())}const{tokenChars:Vn}=_r;var qn={parse:function(e){const t=new Set;let r=-1,n=-1,i=0;for(;i<e.length;i++){const s=e.charCodeAt(i);if(-1===n&&1===Vn[s])-1===r&&(r=i);else if(0===i||32!==s&&9!==s){if(44!==s)throw new SyntaxError(`Unexpected character at index ${i}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${i}`);-1===n&&(n=i);const s=e.slice(r,n);if(t.has(s))throw new SyntaxError(`The "${s}" subprotocol is duplicated`);t.add(s),r=n=-1}}else-1===n&&-1!==r&&(n=i)}if(-1===r||-1!==n)throw new SyntaxError("Unexpected end of input");const s=e.slice(r,i);if(t.has(s))throw new SyntaxError(`The "${s}" subprotocol is duplicated`);return t.add(s),t}};const{createHash:Yn}=g.default,{GUID:Kn,kWebSocket:Jn}=Tt,Qn=/^[+/0-9A-Za-z]{22}==$/;class Xn extends v.default{constructor(e,t){if(super(),null==(e={maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:kn,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=B.default.createServer(((e,t)=>{const r=B.default.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,n)=>{this.handleUpgrade(t,r,n,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(ei,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(ei,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{ei(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,n){t.on("error",ti);const i=e.headers["sec-websocket-key"],s=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void ni(this,e,t,405,"Invalid HTTP method")}if("websocket"!==e.headers.upgrade.toLowerCase()){return void ni(this,e,t,400,"Invalid Upgrade header")}if(!i||!Qn.test(i)){return void ni(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(8!==s&&13!==s){return void ni(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header")}if(!this.shouldHandle(e))return void ri(t,400);const o=e.headers["sec-websocket-protocol"];let a=new Set;if(void 0!==o)try{a=qn.parse(o)}catch(r){return void ni(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const h=e.headers["sec-websocket-extensions"],f={};if(this.options.perMessageDeflate&&void 0!==h){const r=new ur(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=sn.parse(h);e[ur.extensionName]&&(r.accept(e[ur.extensionName]),f[ur.extensionName]=r)}catch(r){return void ni(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const o={origin:e.headers[""+(8===s?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(o,((s,o,h,c)=>{if(!s)return ri(t,o||401,h,c);this.completeUpgrade(f,i,a,e,t,r,n)}));if(!this.options.verifyClient(o))return ri(t,401)}this.completeUpgrade(f,i,a,e,t,r,n)}completeUpgrade(e,t,r,n,i,s,o){if(!i.readable||!i.writable)return i.destroy();if(i[Jn])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return ri(i,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Yn("sha1").update(t+Kn).digest("base64")}`],h=new this.options.WebSocket(null);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,n):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),h._protocol=e)}if(e[ur.extensionName]){const t=e[ur.extensionName].params,r=sn.format({[ur.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),h._extensions=e}this.emit("headers",a,n),i.write(a.concat("\r\n").join("\r\n")),i.removeListener("error",ti),h.setSocket(i,s,{maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(h),h.on("close",(()=>{this.clients.delete(h),this._shouldEmitClose&&!this.clients.size&&process.nextTick(ei,this)}))),o(h,n)}}var Zn=Xn;function ei(e){e._state=2,e.emit("close")}function ti(){this.destroy()}function ri(e,t,r,n){r=r||B.default.STATUS_CODES[t],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...n},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${B.default.STATUS_CODES[t]}\r\n`+Object.keys(n).map((e=>`${e}: ${n[e]}`)).join("\r\n")+"\r\n\r\n"+r)}function ni(e,t,r,n,i){if(e.listenerCount("wsClientError")){const n=new Error(i);Error.captureStackTrace(n,ni),e.emit("wsClientError",n,r,t)}else ri(r,n,i)}var ii=k((function(e,t){e.exports=function(){function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){if(!a&&I)return I(o);if(s)return s(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var f=r[o]={exports:{}};t[o][0].call(f.exports,(function(e){return i(t[o][1][e]||e)}),f,f.exports,e,t,r,n)}return r[o].exports}for(var s=I,o=0;o<n.length;o++)i(n[o]);return i}return e}()({1:[function(e,t,r){var n=Object.prototype.hasOwnProperty,i="~";function s(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function a(e,t,r,n,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new o(r,n||e,s),h=i?i+t:t;return e._events[h]?e._events[h].fn?e._events[h]=[e._events[h],a]:e._events[h].push(a):(e._events[h]=a,e._eventsCount++),e}function h(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function f(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),f.prototype.eventNames=function(){var e,t,r=[];if(0===this._eventsCount)return r;for(t in e=this._events)n.call(e,t)&&r.push(i?t.slice(1):t);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},f.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,s=r.length,o=new Array(s);n<s;n++)o[n]=r[n].fn;return o},f.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},f.prototype.emit=function(e,t,r,n,s,o){var a=i?i+e:e;if(!this._events[a])return!1;var h,f,c=this._events[a],u=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,n),!0;case 5:return c.fn.call(c.context,t,r,n,s),!0;case 6:return c.fn.call(c.context,t,r,n,s,o),!0}for(f=1,h=new Array(u-1);f<u;f++)h[f-1]=arguments[f];c.fn.apply(c.context,h)}else{var l,d=c.length;for(f=0;f<d;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),u){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,r);break;case 4:c[f].fn.call(c[f].context,t,r,n);break;default:if(!h)for(l=1,h=new Array(u-1);l<u;l++)h[l-1]=arguments[l];c[f].fn.apply(c[f].context,h)}}return!0},f.prototype.on=function(e,t,r){return a(this,e,t,r,!1)},f.prototype.once=function(e,t,r){return a(this,e,t,r,!0)},f.prototype.removeListener=function(e,t,r,n){var s=i?i+e:e;if(!this._events[s])return this;if(!t)return h(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||n&&!o.once||r&&o.context!==r||h(this,s);else{for(var a=0,f=[],c=o.length;a<c;a++)(o[a].fn!==t||n&&!o[a].once||r&&o[a].context!==r)&&f.push(o[a]);f.length?this._events[s]=1===f.length?f[0]:f:h(this,s)}return this},f.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&h(this,t)):(this._events=new s,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=i,f.EventEmitter=f,void 0!==t&&(t.exports=f)},{}]},{},[1])(1)}));const si=new TextEncoder,oi=new TextDecoder;class ai extends ii{constructor(e){super(),this.cid="",this.ssid="",this.ip="",this.socket,this.serverURL=e,this.isOpen=!1,this.txCounter=0,this.rxCounter=0,this.lastTxRxTime=Date.now(),this.lastTxRxTimeOut=65e3,this.runCheckPeriod=3e3,this.runCheckIntervalID=null,this.boho=new gt,this.TLS=!1,this.encMode=yt.AUTO,this.useAuth=!1,this.nick="",this.channels=new Set,this.promiseMap=new Map,this.promiseTimeOut=3e3,this.mid=0,this.on("open",this.onOpenEventHandler.bind(this)),this.on("close",this.onCloseEventHandler.bind(this)),this.on("socket_data",this.onWrapSocketMessageEventHandler.bind(this))}onOpenEventHandler(){this.serverURL.includes("wss://")&&(this.TLS=!0),this.isOpen=!0}onCloseEventHandler(){this.isSecre=!1,this.boho.isAuthorized=!1,console.log("-- remote is closed:"),this.isOpen=!1}login(e,t){console.log("try manual instance login: ",e),this.boho.set_id8(e),this.boho.set_key(t),this.useAuth=!0;let r=this.boho.auth_req();this.send(r)}auth(e,t){console.log("set auto auth: ",e),this.boho.set_id8(e),this.boho.set_key(t),this.useAuth=!0}onWrapSocketMessageEventHandler(e){let t,r=e[0];if(r===ft.ENC_488)t=this.boho.decrypt_488(e),t?(r=t[0],e=t):console.log("DEC_FAIL",e.byteLength);else if(r===ft.ENC_E2E)try{if(t=this.boho.decrypt_488(e),!t)return void console.log("488 DEC_FAIL",e);r=t[0],e.set(t,lt.ENC_488),e=e.subarray(lt.ENC_488)}catch(e){return void console.log("E2E DEC_FAIL decryption error",e)}switch(bt[r],r){case bt.PING:this.pong();break;case bt.PONG:break;case bt.IAM_ACK:try{let t=(new TextDecoder).decode(e.subarray(1)),r=JSON.parse(t);r.ip&&(this.ip=r.ip),console.log("<IAM_ACK>",JSON.stringify(r))}catch(e){console.log("<IAM_ACK> data error")}break;case bt.CID_ACK:let t=(new TextDecoder).decode(e.subarray(1));console.log(">> CID_ACK: ",t),this.cid=t,this.subscribe_memory_channels(),this.emit("ready","ready");break;case bt.SERVER_READY:console.log(">> SERVER_READY"),this.useAuth?this.send(this.boho.auth_req()):this.send(j.Buffer.from([bt.CID_REQ]));break;case bt.SIGNAL_E2E:case bt.SIGNAL:try{let t,r,n,i=e.readUint8(1),s=e.subarray(2,2+i),o=oi.decode(s),a=e.readUint8(2+i),h=e.subarray(3+i);switch(o.includes("@")?(n=o.split("@"),t="@",r=n[1],2==n.length?o="@"+r:(o="@",r="")):(n=o.split("#"),t=n[0],r=n[1],1==n.length&&(r=""),t||(t="HOME_CH")),a){case mt.EMPTY:this.emit(o,o);break;case mt.STRING:let t=h.subarray(0,h.byteLength-1),r=oi.decode(t);this.emit(o,r,o),o.includes("@")&&this.emit("@",r,o);break;case mt.BUFFER:this.emit(o,h,o),o.includes("@")&&this.emit("@",h,o);break;case mt.OBJECT:let n=oi.decode(h),i=JSON.parse(n);this.emit(o,i,o);break;case mt.MJSON:let s=oi.decode(h),f=JSON.parse(s);this.emit(o,...f,o);break;case mt.MBA:let c=Z(e);this.emit(o,...c.args,o);break;default:console.log("unkown payloadtype",a)}}catch(e){console.log("signal parse err",e)}break;case bt.SIGNAL_REQ:try{let t=e.readUint8(3),r=e.subarray(4,4+t),n=oi.decode(r),i=Z(e);if(i){let e=i.args;console.log("[PUB_STR_CH_RET] ...args",...e),this.emit(n,...e)}}catch(e){console.log("SIGNAL_REQ err",e)}break;case bt.RESPONSE_MBP:let r=e.readUint8(1),n=e.readUint16BE(2),i=e.byteLength>4?e.subarray(4):"";this.testPromise(n,r,i);break;case ft.AUTH_NONCE:let s=this.boho.auth_hmac(e);s?this.send(s):console.log("Invalid auth_req");break;case ft.AUTH_FAIL:console.log("AUTH FAIL");break;case ft.AUTH_ACK:this.boho.check_auth_ack_hmac(e)?(this.emit("authorized"),this.send(j.Buffer.from([bt.CID_REQ]))):console.log("invalid server hmac")}}iam(e){e?this.send_enc_mode(X(Y("#MsgType","8",bt.IAM),Y("#",e))):this.send_enc_mode(X(Y("#MsgType","8",bt.IAM)))}ping(){this.send(j.Buffer.from([bt.PING]))}pong(){this.send(j.Buffer.from([bt.PONG]))}echo(e){e?(console.log("echo args:",e),this.send_enc_mode(X(Y("#MsgType","8",bt.ECHO),Y("#msg",e)))):this.send(j.Buffer.from([bt.ECHO]))}bin(...e){this.send(re(...e))}send_enc_mode(e,t=!1){if((this.encMode===yt.YES||this.encMode===yt.AUTO&&!this.TLS&&this.boho.isAuthorized)&&(t=!0),e[0]==bt.SIGNAL_E2E&&t){let t=e[1],r=this.boho.encrypt_488(e.subarray(0,3+t));r[0]=ft.ENC_E2E,this.send(j.Buffer.concat([r,e.subarray(3+t)]))}else if(t){let t=this.boho.encrypt_488(e);this.send(t)}else this.send(e)}setMsgPromise(e){return new Promise(((t,r)=>{this.promiseMap.set(e,[t,r]),setTimeout((t=>{this.promiseMap.has(e)&&(r("timeout"),this.promiseMap.delete(e))}),this.promiseTimeOut)}))}testPromise(e,t,r){if(this.promiseMap.has(e)){let n,[i,s]=this.promiseMap.get(e);this.promiseMap.delete(e),r&&(n=Z(r)),t<128?i(n||t):s(n)}}publish(...e){this.signal(...e)}parsePayload(e){let t,r;if(0==e.length)t=mt.EMPTY,r=null;else if(1==e.length)"string"==typeof e[0]||"number"==typeof e[0]?(t=mt.STRING,r=si.encode(e[0]+"."),r[r.byteLength-1]=0):ArrayBuffer.isView(e[0])||e[0]instanceof ArrayBuffer?(t=mt.BUFFER,r=te(e[0])):"object"==typeof e[0]?(t=mt.OBJECT,r=si.encode(JSON.stringify(e[0]))):console.log("unknown type payload arguments");else{let n=!1;e.forEach((e=>{(ArrayBuffer.isView(e)||e instanceof ArrayBuffer)&&(n=!0)})),n?t=mt.MBA:(t=mt.MJSON,r=si.encode(JSON.stringify(e)))}return{type:t,buffer:r}}get_signal_pack(e,...t){if("string"!=typeof e)throw TypeError("target should be string.");let r,n=si.encode(e),i=this.parsePayload(t);return r=i.type==mt.EMPTY?X(Y("#MsgType","8",bt.SIGNAL),Y("#targetLen","8",n.byteLength),Y("#target",n),Y("#payloadType","8",i.type)):i.type==mt.MBA?X(Y("#MsgType","8",bt.SIGNAL),Y("#targetLen","8",n.byteLength),Y("#target",n),Y("#payloadType","8",i.type),K(...t)):X(Y("#MsgType","8",bt.SIGNAL),Y("#targetLen","8",n.byteLength),Y("#target",n),Y("#payloadType","8",i.type),Y("#payload",i.buffer)),r}signal(e,...t){if("string"!=typeof e)throw TypeError("target should be string.");let r=this.get_signal_pack(e,...t);this.send_enc_mode(r)}decrypt_e2e(e,t){return this.boho.decrypt_e2e(e,t)}signal_e2e(e,t,r){if("string"!=typeof e)throw TypeError("target should be string.");let n=si.encode(e),i=te(t),s=this.boho.encrypt_e2e(i,r),o=X(Y("#MsgType","8",bt.SIGNAL_E2E),Y("#targetLen","8",n.byteLength),Y("#target",n),Y("#payloadType","8",mt.BUFFER),Y("#payload",s));this.send_enc_mode(o)}signal_promise(e,...t){let r=this.get_signal_pack(e,...t),n=X(Y("#MsgType","8",bt.SIGNAL_REQ),Y("#mid","16",++this.mid),Y("#sigPack_withoutHeader",r.subarray(1)));return this.send_enc_mode(n),this.setMsgPromise(this.mid)}sudo(e,...t){return this.signal_promise("sudo:"+e,...t)}listen(e,t){if("string"!=typeof e)throw TypeError("tag should be string.");if(e.length>255||0==e.length)throw TypeError("tag string length range: 1~255");if(e.includes("@")||this.channels.add(e),console.log("channels:",this.channels),t){if("function"!=typeof t)throw TypeError("listener handler is not a function");this.on(e,t)}}set(e){if("string"!=typeof e)throw TypeError("target should be string.");if(!this.isOpen)return;let t=si.encode(e);if(t.byteLength>_t.TAG_LEN1)throw TypeError("please use target string bytelength below:"+_t.TAG_LEN1);this.send_enc_mode(j.Buffer.concat([V("8",bt.SET),V("8",t.byteLength),t]))}subscribe(e){if("string"!=typeof e)throw TypeError("tag should be string.");if(!this.isOpen)return;e.split(",").forEach((e=>{this.channels.add(e)}));let t=si.encode(e);if(t.byteLength>_t.TAG_LEN1)throw TypeError("please use tag string bytelength below:"+_t.TAG_LEN1);this.send_enc_mode(j.Buffer.concat([V("8",bt.SUBSCRIBE),V("8",t.byteLength),t]))}request(e){if("string"!=typeof e)throw TypeError("tag should be string.");let t=si.encode(e);if(t.byteLength>_t.TAG_LEN1)throw TypeError("please use tag string bytelength: "+_t.TAG_LEN1);return this.send_enc_mode(j.Buffer.concat([V("8",bt.REQUEST),V("16",++this.mid),V("8",t.byteLength),t])),this.setMsgPromise(this.mid)}subscribe_promise(e){if("string"!=typeof e)throw TypeError("tag should be string.");if(!this.isOpen)return Promise.reject("subscribe_promise:: connection is not open");let t=si.encode(e);if(t.byteLength>_t.TAG_LEN2)throw TypeError("please use tag string bytelength: "+_t.TAG_LEN2);return this.send_enc_mode(j.Buffer.concat([V("8",bt.SUBSCRIBE_REQ),V("16",++this.mid),V("16",t.byteLength),t])),this.setMsgPromise(this.mid)}subscribe_memory_channels(){if(0==this.channels.size)return;let e=Array.from(this.channels).join(",");console.log("<< AUTO_SUBSCRIBE_PROMISE",e),this.subscribe_promise(e).then((e=>{console.log(">> SUBSCRIBE_REQ SUCCESS reg_channels: ",e),console.log("-- local channels: ",this.channels)})).catch((e=>{console.log(">> SUBSCRIBE_REQ FAIL:",e)}))}unsubscribe(e=""){if(console.log("unsub",e),"string"!=typeof e)throw TypeError("tag should be string.");if(""==e)console.log("unsub all"),this.channels.clear();else{e.split(",").forEach((e=>{this.channels.delete(e),this.removeAllListeners(e)}))}let t=si.encode(e);if(t.byteLength>_t.TAG_LEN1)throw TypeError("please use tag string bytelength below:"+_t.TAG_LEN1);this.send_enc_mode(j.Buffer.concat([V("8",bt.UNSUBSCRIBE),V("8",t.byteLength),t]))}}const hi=new TextDecoder;class fi{constructor(){}send_auth_fail(e,t){console.log("-- AUTH_FAIL: ",t),e.send(Buffer.from([ft.AUTH_FAIL]))}async verify_auth_hmac(e,t){try{let r=Z(e,ct.AUTH_HMAC);if(!r)return void this.send_auth_fail(t,"unpack auth_pack");let n="";n=r.id8.includes(0)?hi.decode(r.id8.subarray(0,r.id8.indexOf(0))):hi.decode(r.id8);let i=await this.getAuthKey(n);if(!i)return void this.send_auth_fail(t,"NO ID:"+n);t.boho.copy_id8(r.id8),t.boho.copy_key(i);let s=t.boho.check_auth_hmac(r);if(!s)return void this.send_auth_fail(t,"hmac dismatched");let o=await this.getInfo(n);if(!o)return void this.send_auth_fail(t,"NO Info");if(t.manager.cid_map.has(o.cid))return this.manager.cid_map.get(o.cid).ping(),void this.send_auth_fail(t,"Deny: duplicate login");t.cid&&t.manager.cid_map.delete(t.cid),t.did=n,t.cid=o.cid,t.nick=o.cid,o.adminLevel&&(t.adminLevel=o.adminLevel,console.log("-- admin user: ",t.cid,"level: ",t.adminLevel)),t.manager.cid_map.set(t.cid,t);let a=Array.from(t.manager.cid_map.keys());console.log("-- cid_map list:",a),console.log(">> LOGIN: ",`did: ${t.did} cid: ${t.cid}`),t.send(s)}catch(e){this.send_auth_fail(t,"caught: unknown error"+e)}}}exports.AuthCore=fi,exports.AuthFile=class extends fi{constructor(e){super(),this.AUTH=new Map,this.INFO=new Map,this.PUBLIC=new Map,this.path=e,e?this.loadAuthInfoFile(e):console.log("no authinfofile path."),console.log("authfromfile path:",e)}async getAuthKey(e){return this.AUTH.get(e)}async getInfo(e){return this.INFO.get(e)}async getPublic(e){return this.PUBLIC.get(e)}loadAuthInfoFile(e){let t=n.readFileSync(e);t=(new TextDecoder).decode(t),JSON.parse(t).forEach((e=>{this.addAuthInfo(...e)})),console.log("total AUTH,INFO size: ",this.AUTH.size,this.INFO.size)}addAuthInfo(e,t,r){let n=Buffer.from(ge.hash(t));this.AUTH.set(e,n),this.INFO.set(e,{cid:r})}setPublic(e,t={}){this.PUBLIC.set(e,t)}},exports.ENC_MODE=yt,exports.Meta=wt,exports.PAYLOAD_TYPE=mt,exports.Remote=class extends ai{constructor(e){super(e),this.connect()}runChecker(e){1!==this.socket?.readyState&&this.connect()}close(){this.socket?.close(),this.socket=null,clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=null}open(e){this.connect(e)}connect(e){e&&(this.serverURL=e),this.runCheckIntervalID&&clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=setInterval(this.runChecker.bind(this),this.runCheckPeriod),console.log("+"),this.socket?.close(),this.socket=null,this.socket=new kn(this.serverURL),this.socket.onopen=e=>{this.socket.on("message",this.onWebSocketMessage.bind(this)),this.emit("open")},this.socket.onerror=e=>{this.emit("error",e)},this.socket.onclose=e=>{this.emit("close")}}onWebSocketMessage(e){this.rxCounter++,this.lastTxRxTime=Date.now(),this.emit("socket_data",e)}send(e){1===this.socket?.readyState?(this.socket.send(e),this.txCounter++,this.lastTxRxTime=Date.now()):console.log("send()::socket not open")}},exports.RemoteCongTCP=class extends ai{constructor(e){super(e),this.connect()}runChecker(e){"open"!=this.socket?.readyState&&this.connect()}close(){this.socket?.end(),this.socket=null,clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=null}open(e){this.connect(e)}connect(e){e&&(this.serverURL=e),this.runCheckIntervalID&&clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=setInterval(this.runChecker.bind(this),this.runCheckPeriod),console.log("+"),this.socket?.end(),this.socket=null;let t=new URL(this.serverURL);console.log("connect port, url",t.port,t.hostname),this.socket=p.default.createConnection(t.port,t.hostname),this.socket.on("connect",(e=>{console.log("tcp connected"),this.congRx=new fe,this.socket.pipe(this.congRx),this.congRx.on("data",this.onTCPSocketMessage.bind(this)),this.emit("open")})),this.socket.on("error",(e=>{this.emit("error",e)})),this.socket.on("close",(e=>{this.emit("close")}))}onTCPSocketMessage(e){this.rxCounter++,this.lastTxRxTime=Date.now(),this.emit("socket_data",e)}send(e){if("open"==this.socket?.readyState){let t=he(e);this.socket.write(t),this.txCounter++,this.lastTxRxTime=Date.now()}else console.log("send()::socket not open")}},exports.RemoteMsg=bt,exports.RemoteOptions=ce,exports.RemoteServer=class{constructor(e,t){this.options=e;let r=parseInt(e.timeout);r&&r>=1e3&&(ce.pingTimeout=r);let n=parseInt(e.monitorPeriod);n&&n>=1e3&&(ce.monitorPeriod=n),console.log("ws listen:",e.port),this.wss=new Zn(e),this.wss.setMaxListeners(0),this.manager=new It(t),this.wss.on("error",(e=>{console.error("### ws server error:",e)})),this.wss.on("close",(e=>{console.log("remoon server closed.",e)})),this.wss.on("connection",((e,t)=>{e.isWS=!0,this.manager.addClient(e,t)})),this.tcpPort=parseInt(e.port)+1,console.log("tcp listen:",this.tcpPort),this.tcpserver=p.default.createServer((e=>{this.manager.addClient(e)})).on("data",(e=>{console.log("tcp server data:",e)})).on("error",(e=>{console.log("RemoteServer.js: tcpserver error:",e)})).listen(this.tcpPort,(()=>{console.log("server bound")}))}},exports.SIZE_LIMIT=_t,exports.TCP_PORT=7778,exports.WS_PORT=7777,exports.timeStamp=L;
