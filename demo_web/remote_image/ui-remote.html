<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .colorbutton{
            border: 1px solid rgba(0,0,0,0.1);
            color: white;
            padding: 5px;
            font-size: 2em;
        }
        #connectionState{
            color: red;
            font-size: 1.5em;
        }
        button{
            padding: 10px;
            margin: 5px;
        }

        .remote_screen{
          border: 1px solid gray;
          padding: 5px;
        }
        iframe{
          /* width: 100%; */
        }
    </style>
</head>
<body>
  <h1>ui remote</h1>
  <iframe id="dui",
  name = "fr1"
  title="device ui"
  width="300"
  height="200"
  src="">
</iframe>
<button id="searchBtn">SEARCH</button>
</button>

<button id="postBtn">POST MESSAGE</button>
<button id="authUIBtn">AUTH UI</button>
<script src="../remocon.min.js?v=24"></script>
<script>

      let wsURL = "";
      if(document.location.host.includes('localhost')){
          wsURL = 'ws://localhost:7777'
        }else{
          wsURL = 'wss://' + document.location.host +'/ws'
        }
        let remocon = new Remocon(wsURL )

        // remocon.listen('#remote',eventHandler)

        // function eventHandler( ...args){
        //     console.log('@receive: ', ...args )
        // }
        remocon.auth('remo','remo')

        remocon.on('ready',e=>{
          remocon.signal('#search', remocon.cid )
        })

        let remoteCID = 'nop'
        remocon.listen('#notify',( cid )=>{
            console.log( '#notify id:', cid  )

            remocon.request(cid ).then( res=>{
              console.log('request_response:', res )
              remoteCID = cid 
              dui.src = res.result 
            })

        })

        remocon.listen('@pong',( ...args )=>{
            console.log( 'main @pong', args  )
        })
        
        remocon.listen('@',( ...args )=>{
            console.log( 'main @', args  )
        })


        searchBtn.onclick = ()=>{
          remocon.signal('#search', remocon.cid )
        }

        let originURL = document.location.origin

        postBtn.addEventListener('click',e=>{
          dui.contentWindow.postMessage("hello there!", originURL);
        })

        let viewAuth = { 
              type: "auth", 
              wsURL: 'ws://localhost:7777' , 
              did:'view1', 
              dkey:'view1',
              device_cid: 'nop'
            }

        authUIBtn.addEventListener('click',e=>{
          dui.contentWindow.postMessage( viewAuth, originURL );
        })


        window.addEventListener("message", (event) => {
          if (event.origin !== originURL ){
            console.log('deny origin')
            return;
          }
          console.log( 'main recv message from iframe:', event )
          let data = event.data

          console.log(data.type )
          if( data.type == 'view_ready'){
            console.log('view ready data. send auth')
            viewAuth.device_cid = remoteCID
            event.source.postMessage( viewAuth , originURL )


          }

        }, false);


    
</script>
</body>
</html>