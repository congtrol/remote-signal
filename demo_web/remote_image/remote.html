<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .colorbutton{
            border: 1px solid rgba(0,0,0,0.1);
            color: white;
            padding: 5px;
            font-size: 2em;
        }
        #connectionState{
            color: red;
            font-size: 1.5em;
        }
        button{
            padding: 10px;
            margin: 5px;
        }

        .remote_screen{
          border: 1px solid gray;
          padding: 5px;
        }
    </style>
</head>
<body>
  <h1>remocon signal</h1>
<h2>1. broadcasting to channel( multiple listeners):  1 to N</h2>
<h3>1-1. send index number of image</h3>
    <div class="select">
        <button >1</button>
        <button >2</button>
        <button >3</button>
        <button >4</button>
        <button >5</button>
        <button >6</button>
        <button >7</button> 
    </div>
<h3>1-2. change hue value of image</h3>
    <input type="range" name="s1" id="multiHue" step="5">
<h3>1-3. send one image file : multiple receivers</h3>
    <div>
      <input type="file" name="" id="fileInput_to_channel" >
    </div>  

    
<h2>2. direct messsage: 1 to 1</h2>
<h3>2-1. request screen id</h3>
<div>
  <button id = 'search'>SEARCH DEVICES</button>
</div>
<h3>2-2. select one screeen</h3>
<div id="screen_list">
  NO SCREEN
</div>
<br>
<span><b>current target screen id:</b></span>
<span id="target_id"></span>
<h3>2-3. change hue value of image</h3>
    <input type="range" name="s1" id="uniHue" step="5">
<h3>2-4. select one image file: for the one receiver</h3>
  <div>
    <input type="file" name="" id="fileInput_to_id" >
  </div>  

    <script src="../../dist/remote-signal.min.js?v=1"></script>
<script>

      let wsURL = "";
      if(document.location.host.includes('localhost')){
          wsURL = 'ws://localhost:7777'
        }else{
          wsURL = 'wss://' + document.location.host +'/ws'
        }
        let remocon = new Remocon(wsURL )

        // remocon.listen('#remote',eventHandler)

        // function eventHandler( ...args){
        //     console.log('@receive: ', ...args )
        // }
        
        // remocon.auth('remo','remo')
        remocon.on('ready',e=>{
          remocon.signal('#search', remocon.cid )
        })

        function addScreen(id){
          screens.add( id )
          redrawScreenButtons( )
        }

        function removeScreen(id){
          screens.delete( id )
          redrawScreenButtons( )
        }
        function clearScreenList(){
          screens.clear();
          redrawScreenButtons( )
        }

        

      
        // broadcasting signal to:  channel
        remocon.listen('#close',( id )=>{
            console.log( '#close id:', id  )
            removeScreen(id)
        })

        remocon.listen('#notify',( id )=>{
            console.log( '#notify id:', id  )
            addScreen(id)
        })

        let screens = new Set();
        // direct signal to:  remocon.cid
        remocon.listen('@screen_id',( id )=>{
            console.log( 'response @screen_id id:', id  )
            addScreen(id)
        })

        const reqBtn = document.querySelector('#search')
        reqBtn.onclick = ()=>{
          clearScreenList();
          remocon.signal('#search', remocon.cid )
        }

        fileInput_to_channel.addEventListener('change',e=>{

            let file = fileInput_to_channel.files[0]
            console.log(  file )

            file.arrayBuffer().then( buffer =>{
                remocon.signal('#image', buffer )
            })

           
        })
        fileInput_to_id.addEventListener('change',e=>{

            let file = fileInput_to_id.files[0]
            console.log(  file )

            if( currentTarget.textContent != ""){
              file.arrayBuffer().then( buffer =>{
                  remocon.signal( currentTarget.textContent + '@image', buffer )
              })

            }else{
              console.log('no screen: select screen.')
            }
           
        })

        // multiHue.addEventListener('change',e=>{
        multiHue.addEventListener('input',e=>{
            let hue = Math.floor( multiHue.value *  3.6 )
            console.log('hue', hue)
            remocon.signal('#control','hue', hue )
        })

        // uniHue.addEventListener('change',e=>{
        uniHue.addEventListener('input',e=>{
            let hue = Math.floor( uniHue.value *  3.6 )
            console.log('hue', hue)
            remocon.signal( currentTarget.textContent + '@hue', hue )
            // remocon.signal( currentTarget.textContent  ,'hue', hue )
        })

        let buttons = document.querySelectorAll('.select>button')

        buttons.forEach(btn=>{
                btn.addEventListener('click',e=>{
            let name = btn.innerText;
            console.log(name)
            remocon.signal('#control','img', name )
            multiHue.dispatchEvent( new Event('change'))

         })
        })

    let screenSelector = document.querySelector('#screen_list')
    let currentTarget = document.querySelector('#target_id')

    function redrawScreenButtons( ){
      let list = Array.from( screens.keys() )
      
      screenSelector.innerHTML = ""
        list.forEach( item =>{
          console.log('itmes', item)

          let s = document.createElement('div')
          s.setAttribute('class','remote_screen')
          s.textContent = item 
          s.addEventListener('click', e=>{
            console.log('selected', s.textContent )
            currentTarget.textContent = s.textContent
          })
          screenSelector.append(s)
        })

    }
</script>
</body>
</html>